name: Deploy Docs

on:
  push:
    branches: [main]
    paths:
      - 'docs/**'
      - 'zensical.toml'
      - 'benchmarks/**'
      - 'rusket/**/*.py'   # re-generate API ref on source changes
      - 'scripts/**'        # re-run if the generation scripts themselves change
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0  # needed for git-cliff (full history)

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Install dependencies
        run: uv sync --all-extras --dev

      - name: Install Rust toolchain (needed to build rusket for import)
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Build rusket (needed for API introspection)
        run: uv run maturin develop --release

      - name: Install git-cliff
        uses: taiki-e/install-action@v2
        with:
          tool: git-cliff

      # ── Doc generation ────────────────────────────────────────────────
      - name: Sync changelog → docs/changelog.md
        run: uv run python scripts/sync_changelog.py

      - name: Generate API reference → docs/api-reference.md
        run: uv run python scripts/gen_api_reference.py

      - name: Rebuild llm.txt
        run: uv run python scripts/gen_llm_txt.py

      - name: Evaluate doc snippets and generate Markdown tables
        run: uv run python scripts/eval_doc_snippets.py

      # ── Benchmarks ───────────────────────────────────────────────────
      - name: Generate Scale Benchmark
        run: uv run python benchmarks/bench_scale.py

      - name: Generate ALS Benchmark (1M)
        run: uv run python benchmarks/bench_als.py --size 1m
        # Note: 25M/1B are excluded from CI due to runner time/memory limits.

      # ── Build & deploy to GitHub Pages ───────────────────────────────
      - name: Build docs with Zensical
        run: uv run zensical build

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
