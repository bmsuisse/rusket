
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Blazing-fast FP-Growth, PrefixSpan, and Recommender Engines for Python ‚Äî pure Rust via PyO3.">
      
      
      
        <link rel="canonical" href="https://bmsuisse.github.io/rusket/cookbook/">
      
      
        <link rel="prev" href="../api-reference/">
      
      
        <link rel="next" href="../notebooks/1_online_retail_basket_analysis/">
      
      
        
      
      
      <link rel="icon" href="../assets/favicon.svg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.2">
    
    
      
        <title>Cookbook (Code) - rusket</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Inter";--md-code-font:"JetBrains Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-orange" data-md-color-accent="deep-orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#rusket-cookbook" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="rusket" class="md-header__button md-logo" aria-label="rusket" data-md-component="logo">
      
  <img src="../assets/logo_single.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            rusket
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Cookbook (Code)
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="deep-orange" data-md-color-accent="deep-orange"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="deep-orange" data-md-color-accent="deep-orange"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/bmsuisse/rusket" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    bmsuisse/rusket
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../quickstart/" class="md-tabs__link">
          
  
  
  Getting Started

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../api-reference/" class="md-tabs__link">
          
  
  
  User Guide

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../changelog/" class="md-tabs__link">
          
  
  
  Reference

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="rusket" class="md-nav__button md-logo" aria-label="rusket" data-md-component="logo">
      
  <img src="../assets/logo_single.svg" alt="logo">

    </a>
    rusket
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/bmsuisse/rusket" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    bmsuisse/rusket
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Getting Started
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../quickstart/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quick Start
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../migration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Migration from mlxtend
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    User Guide
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    User Guide
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../api-reference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Cookbook (Code)
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Cookbook (Code)
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#setup" class="md-nav__link">
    <span class="md-ellipsis">
      
        Setup
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-market-basket-analysis-grocery-retail" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Market Basket Analysis ‚Äî Grocery Retail
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. Market Basket Analysis ‚Äî Grocery Retail">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#business-context" class="md-nav__link">
    <span class="md-ellipsis">
      
        Business context
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prepare-the-basket-data" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prepare the basket data
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#find-frequent-product-combinations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Find frequent product combinations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generate-cross-sell-rules" class="md-nav__link">
    <span class="md-ellipsis">
      
        Generate cross-sell rules
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#limit-itemset-length-for-large-catalogues" class="md-nav__link">
    <span class="md-ellipsis">
      
        Limit itemset length for large catalogues
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-eclat-when-to-use-vs-fpgrowth" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. ECLAT ‚Äî When to Use vs FPGrowth
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-transaction-helpers" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Transaction Helpers
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. Transaction Helpers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#from-a-pandas-dataframe" class="md-nav__link">
    <span class="md-ellipsis">
      
        From a Pandas DataFrame
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#from-a-polars-dataframe" class="md-nav__link">
    <span class="md-ellipsis">
      
        From a Polars DataFrame
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#from-a-spark-dataframe" class="md-nav__link">
    <span class="md-ellipsis">
      
        From a Spark DataFrame
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-collaborative-filtering-with-als-for-you-personalisation" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Collaborative Filtering with ALS ‚Äî "For You" Personalisation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Collaborative Filtering with ALS ‚Äî &#34;For You&#34; Personalisation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#business-context_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Business context
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fit-from-purchase-history-event-log" class="md-nav__link">
    <span class="md-ellipsis">
      
        Fit from purchase history (event log)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-personalised-recommendations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Get personalised recommendations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fit-from-transaction-data" class="md-nav__link">
    <span class="md-ellipsis">
      
        Fit from transaction data
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#access-latent-factors-directly" class="md-nav__link">
    <span class="md-ellipsis">
      
        Access latent factors directly
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-out-of-core-als-for-1b-ratings" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. Out-of-Core ALS for 1B+ Ratings
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. Out-of-Core ALS for 1B+ Ratings">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#download-and-prepare-the-movielens-1b-dataset" class="md-nav__link">
    <span class="md-ellipsis">
      
        Download and prepare the MovieLens 1B dataset
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build-the-out-of-core-csr-matrix" class="md-nav__link">
    <span class="md-ellipsis">
      
        Build the out-of-core CSR matrix
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fit-als-on-the-out-of-core-matrix" class="md-nav__link">
    <span class="md-ellipsis">
      
        Fit ALS on the out-of-core matrix
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-bayesian-personalized-ranking-bpr" class="md-nav__link">
    <span class="md-ellipsis">
      
        6. Bayesian Personalized Ranking (BPR)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-sequential-pattern-mining-prefixspan" class="md-nav__link">
    <span class="md-ellipsis">
      
        7. Sequential Pattern Mining (PrefixSpan)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-high-utility-pattern-mining-hupm-profit-driven-bundle-discovery" class="md-nav__link">
    <span class="md-ellipsis">
      
        8. High-Utility Pattern Mining (HUPM) ‚Äî Profit-Driven Bundle Discovery
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-native-polars-integration" class="md-nav__link">
    <span class="md-ellipsis">
      
        9. Native Polars Integration
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9. Native Polars Integration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#query-itemsets-with-pyarrow-compute" class="md-nav__link">
    <span class="md-ellipsis">
      
        Query itemsets with PyArrow compute
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#convert-to-python-sets-only-for-small-subsets" class="md-nav__link">
    <span class="md-ellipsis">
      
        Convert to Python sets (only for small subsets)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-spark-databricks-integration" class="md-nav__link">
    <span class="md-ellipsis">
      
        10. Spark / Databricks Integration
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10. Spark / Databricks Integration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#101-streaming-1b-rows-from-spark-zero-copy" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.1 Streaming 1B+ Rows from Spark (Zero-Copy)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#102-distributed-parallel-mining-grouped" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.2 Distributed Parallel Mining (Grouped)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#103-collaborative-filtering-als-from-spark" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.3 Collaborative Filtering (ALS) from Spark
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-tuning-guide" class="md-nav__link">
    <span class="md-ellipsis">
      
        11. Tuning Guide
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="11. Tuning Guide">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fpgrowth-eclat" class="md-nav__link">
    <span class="md-ellipsis">
      
        FPGrowth / ECLAT
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#als" class="md-nav__link">
    <span class="md-ellipsis">
      
        ALS
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bpr" class="md-nav__link">
    <span class="md-ellipsis">
      
        BPR
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefixspan-hupm" class="md-nav__link">
    <span class="md-ellipsis">
      
        PrefixSpan &amp; HUPM
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recommendation-quality-tips" class="md-nav__link">
    <span class="md-ellipsis">
      
        Recommendation quality tips
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-sequential-pattern-mining-prefixspan" class="md-nav__link">
    <span class="md-ellipsis">
      
        9. Sequential Pattern Mining (PrefixSpan)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9. Sequential Pattern Mining (PrefixSpan)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prepare-the-event-log-pandas-polars-or-spark" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prepare the Event Log (Pandas, Polars, or Spark)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mine-sequential-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Mine Sequential Patterns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-high-utility-pattern-mining-hupm" class="md-nav__link">
    <span class="md-ellipsis">
      
        10. High-Utility Pattern Mining (HUPM)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-bayesian-personalized-ranking-bpr" class="md-nav__link">
    <span class="md-ellipsis">
      
        11. Bayesian Personalized Ranking (BPR)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12-item-similarity-and-cross-selling-potential" class="md-nav__link">
    <span class="md-ellipsis">
      
        12. Item Similarity and Cross-Selling Potential
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="12. Item Similarity and Cross-Selling Potential">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#find-similar-products-item-to-item" class="md-nav__link">
    <span class="md-ellipsis">
      
        Find Similar Products (Item-to-Item)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#calculate-cross-selling-potential" class="md-nav__link">
    <span class="md-ellipsis">
      
        Calculate Cross-Selling Potential
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#13-hybrid-recommender-als-association-rules" class="md-nav__link">
    <span class="md-ellipsis">
      
        13. Hybrid Recommender (ALS + Association Rules)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#14-genai-llm-stack-integration" class="md-nav__link">
    <span class="md-ellipsis">
      
        14. GenAI / LLM Stack Integration
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="14. GenAI / LLM Stack Integration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vector-export-vector-databases-lancedb" class="md-nav__link">
    <span class="md-ellipsis">
      
        Vector Export &amp; Vector Databases (LanceDB)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fast-item-to-item-similarity" class="md-nav__link">
    <span class="md-ellipsis">
      
        Fast Item-to-Item Similarity
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#graph-generation-for-community-detection" class="md-nav__link">
    <span class="md-ellipsis">
      
        Graph Generation for Community Detection
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#15-visualizing-latent-spaces-pca" class="md-nav__link">
    <span class="md-ellipsis">
      
        15. Visualizing Latent Spaces (PCA)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#16-translating-spark-mllib-to-rusket" class="md-nav__link">
    <span class="md-ellipsis">
      
        16. Translating Spark MLlib to rusket
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="16. Translating Spark MLlib to rusket">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spark-version-original" class="md-nav__link">
    <span class="md-ellipsis">
      
        Spark Version (Original)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rusket-version-equivalent" class="md-nav__link">
    <span class="md-ellipsis">
      
        rusket Version (Equivalent)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#explanation-of-key-differences" class="md-nav__link">
    <span class="md-ellipsis">
      
        Explanation of Key Differences
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Cookbook (Interactive Notebooks)
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Cookbook (Interactive Notebooks)
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/1_online_retail_basket_analysis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    üõí Retail Assortment Optimization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/2_movielens_recommendations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    üé¨ MovieLens Hybrid Recommender
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../notebooks/3_ecommerce_lifecycle_mining/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ‚è±Ô∏è E-Commerce Lifecycle Discovery
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../recommender/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Recommender Workflows
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../streaming/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Streaming & Big Data
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../spark/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    PySpark Integration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../polars/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Polars Support
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../benchmarks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Benchmarks
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../1b-challenge/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    The 1B Challenge
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../changelog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Changelog
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#setup" class="md-nav__link">
    <span class="md-ellipsis">
      
        Setup
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-market-basket-analysis-grocery-retail" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Market Basket Analysis ‚Äî Grocery Retail
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. Market Basket Analysis ‚Äî Grocery Retail">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#business-context" class="md-nav__link">
    <span class="md-ellipsis">
      
        Business context
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prepare-the-basket-data" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prepare the basket data
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#find-frequent-product-combinations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Find frequent product combinations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generate-cross-sell-rules" class="md-nav__link">
    <span class="md-ellipsis">
      
        Generate cross-sell rules
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#limit-itemset-length-for-large-catalogues" class="md-nav__link">
    <span class="md-ellipsis">
      
        Limit itemset length for large catalogues
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-eclat-when-to-use-vs-fpgrowth" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. ECLAT ‚Äî When to Use vs FPGrowth
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-transaction-helpers" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Transaction Helpers
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. Transaction Helpers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#from-a-pandas-dataframe" class="md-nav__link">
    <span class="md-ellipsis">
      
        From a Pandas DataFrame
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#from-a-polars-dataframe" class="md-nav__link">
    <span class="md-ellipsis">
      
        From a Polars DataFrame
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#from-a-spark-dataframe" class="md-nav__link">
    <span class="md-ellipsis">
      
        From a Spark DataFrame
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-collaborative-filtering-with-als-for-you-personalisation" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Collaborative Filtering with ALS ‚Äî "For You" Personalisation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Collaborative Filtering with ALS ‚Äî &#34;For You&#34; Personalisation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#business-context_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Business context
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fit-from-purchase-history-event-log" class="md-nav__link">
    <span class="md-ellipsis">
      
        Fit from purchase history (event log)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-personalised-recommendations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Get personalised recommendations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fit-from-transaction-data" class="md-nav__link">
    <span class="md-ellipsis">
      
        Fit from transaction data
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#access-latent-factors-directly" class="md-nav__link">
    <span class="md-ellipsis">
      
        Access latent factors directly
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-out-of-core-als-for-1b-ratings" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. Out-of-Core ALS for 1B+ Ratings
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. Out-of-Core ALS for 1B+ Ratings">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#download-and-prepare-the-movielens-1b-dataset" class="md-nav__link">
    <span class="md-ellipsis">
      
        Download and prepare the MovieLens 1B dataset
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build-the-out-of-core-csr-matrix" class="md-nav__link">
    <span class="md-ellipsis">
      
        Build the out-of-core CSR matrix
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fit-als-on-the-out-of-core-matrix" class="md-nav__link">
    <span class="md-ellipsis">
      
        Fit ALS on the out-of-core matrix
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-bayesian-personalized-ranking-bpr" class="md-nav__link">
    <span class="md-ellipsis">
      
        6. Bayesian Personalized Ranking (BPR)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-sequential-pattern-mining-prefixspan" class="md-nav__link">
    <span class="md-ellipsis">
      
        7. Sequential Pattern Mining (PrefixSpan)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-high-utility-pattern-mining-hupm-profit-driven-bundle-discovery" class="md-nav__link">
    <span class="md-ellipsis">
      
        8. High-Utility Pattern Mining (HUPM) ‚Äî Profit-Driven Bundle Discovery
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-native-polars-integration" class="md-nav__link">
    <span class="md-ellipsis">
      
        9. Native Polars Integration
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9. Native Polars Integration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#query-itemsets-with-pyarrow-compute" class="md-nav__link">
    <span class="md-ellipsis">
      
        Query itemsets with PyArrow compute
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#convert-to-python-sets-only-for-small-subsets" class="md-nav__link">
    <span class="md-ellipsis">
      
        Convert to Python sets (only for small subsets)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-spark-databricks-integration" class="md-nav__link">
    <span class="md-ellipsis">
      
        10. Spark / Databricks Integration
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10. Spark / Databricks Integration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#101-streaming-1b-rows-from-spark-zero-copy" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.1 Streaming 1B+ Rows from Spark (Zero-Copy)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#102-distributed-parallel-mining-grouped" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.2 Distributed Parallel Mining (Grouped)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#103-collaborative-filtering-als-from-spark" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.3 Collaborative Filtering (ALS) from Spark
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-tuning-guide" class="md-nav__link">
    <span class="md-ellipsis">
      
        11. Tuning Guide
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="11. Tuning Guide">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#fpgrowth-eclat" class="md-nav__link">
    <span class="md-ellipsis">
      
        FPGrowth / ECLAT
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#als" class="md-nav__link">
    <span class="md-ellipsis">
      
        ALS
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bpr" class="md-nav__link">
    <span class="md-ellipsis">
      
        BPR
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefixspan-hupm" class="md-nav__link">
    <span class="md-ellipsis">
      
        PrefixSpan &amp; HUPM
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recommendation-quality-tips" class="md-nav__link">
    <span class="md-ellipsis">
      
        Recommendation quality tips
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-sequential-pattern-mining-prefixspan" class="md-nav__link">
    <span class="md-ellipsis">
      
        9. Sequential Pattern Mining (PrefixSpan)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9. Sequential Pattern Mining (PrefixSpan)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prepare-the-event-log-pandas-polars-or-spark" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prepare the Event Log (Pandas, Polars, or Spark)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mine-sequential-patterns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Mine Sequential Patterns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-high-utility-pattern-mining-hupm" class="md-nav__link">
    <span class="md-ellipsis">
      
        10. High-Utility Pattern Mining (HUPM)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-bayesian-personalized-ranking-bpr" class="md-nav__link">
    <span class="md-ellipsis">
      
        11. Bayesian Personalized Ranking (BPR)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12-item-similarity-and-cross-selling-potential" class="md-nav__link">
    <span class="md-ellipsis">
      
        12. Item Similarity and Cross-Selling Potential
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="12. Item Similarity and Cross-Selling Potential">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#find-similar-products-item-to-item" class="md-nav__link">
    <span class="md-ellipsis">
      
        Find Similar Products (Item-to-Item)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#calculate-cross-selling-potential" class="md-nav__link">
    <span class="md-ellipsis">
      
        Calculate Cross-Selling Potential
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#13-hybrid-recommender-als-association-rules" class="md-nav__link">
    <span class="md-ellipsis">
      
        13. Hybrid Recommender (ALS + Association Rules)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#14-genai-llm-stack-integration" class="md-nav__link">
    <span class="md-ellipsis">
      
        14. GenAI / LLM Stack Integration
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="14. GenAI / LLM Stack Integration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vector-export-vector-databases-lancedb" class="md-nav__link">
    <span class="md-ellipsis">
      
        Vector Export &amp; Vector Databases (LanceDB)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fast-item-to-item-similarity" class="md-nav__link">
    <span class="md-ellipsis">
      
        Fast Item-to-Item Similarity
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#graph-generation-for-community-detection" class="md-nav__link">
    <span class="md-ellipsis">
      
        Graph Generation for Community Detection
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#15-visualizing-latent-spaces-pca" class="md-nav__link">
    <span class="md-ellipsis">
      
        15. Visualizing Latent Spaces (PCA)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#16-translating-spark-mllib-to-rusket" class="md-nav__link">
    <span class="md-ellipsis">
      
        16. Translating Spark MLlib to rusket
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="16. Translating Spark MLlib to rusket">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spark-version-original" class="md-nav__link">
    <span class="md-ellipsis">
      
        Spark Version (Original)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rusket-version-equivalent" class="md-nav__link">
    <span class="md-ellipsis">
      
        rusket Version (Equivalent)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#explanation-of-key-differences" class="md-nav__link">
    <span class="md-ellipsis">
      
        Explanation of Key Differences
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="rusket-cookbook">Rusket Cookbook<a class="headerlink" href="#rusket-cookbook" title="Permanent link">&para;</a></h1>
<p>A hands-on guide to every feature in <code>rusket</code> ‚Äî from market basket analysis to billion-scale collaborative filtering.</p>
<hr />
<h2 id="setup">Setup<a class="headerlink" href="#setup" title="Permanent link">&para;</a></h2>
<div class="language-python highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="n">pip</span> <span class="n">install</span> <span class="n">rusket</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">polars</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pl</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rusket</span><span class="w"> </span><span class="kn">import</span> <span class="n">mine</span><span class="p">,</span> <span class="n">eclat</span><span class="p">,</span> <span class="n">association_rules</span><span class="p">,</span> <span class="n">ALS</span><span class="p">,</span> <span class="n">BPR</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rusket</span><span class="w"> </span><span class="kn">import</span> <span class="n">prefixspan</span><span class="p">,</span> <span class="n">sequences_from_event_log</span><span class="p">,</span> <span class="n">hupm</span><span class="p">,</span> <span class="n">similar_items</span><span class="p">,</span> <span class="n">Recommender</span><span class="p">,</span> <span class="n">score_potential</span>
</span></code></pre></div>
<hr />
<h2 id="1-market-basket-analysis-grocery-retail">1. Market Basket Analysis ‚Äî Grocery Retail<a class="headerlink" href="#1-market-basket-analysis-grocery-retail" title="Permanent link">&para;</a></h2>
<h3 id="business-context">Business context<a class="headerlink" href="#business-context" title="Permanent link">&para;</a></h3>
<p>A supermarket chain wants to identify which product combinations appear most frequently in customer baskets across all checkout terminals. The output drives:</p>
<ul>
<li><strong>"Frequently Bought Together"</strong> widgets on the self-checkout screen</li>
<li><strong>Shelf adjacency</strong> decisions (place high-lift pairs closer together)</li>
<li><strong>Promotional bundles</strong> (discount pairs with high confidence but low current margin)</li>
</ul>
<h3 id="prepare-the-basket-data">Prepare the basket data<a class="headerlink" href="#prepare-the-basket-data" title="Permanent link">&para;</a></h3>
<p>In practice this comes from your POS system as a long-format order table. For demonstration we build a plausible synthetic dataset:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rusket</span><span class="w"> </span><span class="kn">import</span> <span class="n">from_transactions</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="c1"># Realistic grocery catalogue with purchase probabilities (power-law distributed)</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="n">categories</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>    <span class="s2">&quot;Milk&quot;</span><span class="p">:</span> <span class="mf">0.55</span><span class="p">,</span> <span class="s2">&quot;Bread&quot;</span><span class="p">:</span> <span class="mf">0.52</span><span class="p">,</span> <span class="s2">&quot;Butter&quot;</span><span class="p">:</span> <span class="mf">0.36</span><span class="p">,</span> <span class="s2">&quot;Eggs&quot;</span><span class="p">:</span> <span class="mf">0.41</span><span class="p">,</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>    <span class="s2">&quot;Cheese&quot;</span><span class="p">:</span> <span class="mf">0.28</span><span class="p">,</span> <span class="s2">&quot;Yogurt&quot;</span><span class="p">:</span> <span class="mf">0.22</span><span class="p">,</span> <span class="s2">&quot;Coffee&quot;</span><span class="p">:</span> <span class="mf">0.31</span><span class="p">,</span> <span class="s2">&quot;Tea&quot;</span><span class="p">:</span> <span class="mf">0.18</span><span class="p">,</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>    <span class="s2">&quot;Sugar&quot;</span><span class="p">:</span> <span class="mf">0.20</span><span class="p">,</span> <span class="s2">&quot;Apples&quot;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span> <span class="s2">&quot;Bananas&quot;</span><span class="p">:</span> <span class="mf">0.30</span><span class="p">,</span> <span class="s2">&quot;Oranges&quot;</span><span class="p">:</span> <span class="mf">0.15</span><span class="p">,</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>    <span class="s2">&quot;Chicken&quot;</span><span class="p">:</span> <span class="mf">0.35</span><span class="p">,</span> <span class="s2">&quot;Pasta&quot;</span><span class="p">:</span> <span class="mf">0.27</span><span class="p">,</span> <span class="s2">&quot;Tomato Sauce&quot;</span><span class="p">:</span> <span class="mf">0.26</span><span class="p">,</span> <span class="s2">&quot;Onions&quot;</span><span class="p">:</span> <span class="mf">0.40</span><span class="p">,</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="p">}</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="n">n_receipts</span> <span class="o">=</span> <span class="mi">10_000</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="n">df_long</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a>    <span class="p">[(</span><span class="n">receipt</span><span class="p">,</span> <span class="n">product</span><span class="p">)</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a>     <span class="k">for</span> <span class="n">receipt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_receipts</span><span class="p">)</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a>     <span class="k">for</span> <span class="n">product</span><span class="p">,</span> <span class="n">prob</span> <span class="ow">in</span> <span class="n">categories</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a>     <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">prob</span><span class="p">],</span>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a>    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;receipt_id&quot;</span><span class="p">,</span> <span class="s2">&quot;product&quot;</span><span class="p">],</span>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a><span class="p">)</span>
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Simulated </span><span class="si">{</span><span class="n">n_receipts</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> receipts, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_long</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> line items&quot;</span><span class="p">)</span>
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a>
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a><span class="c1"># Convert to one-hot basket matrix</span>
</span><span id="__span-2-26"><a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a><span class="n">basket</span> <span class="o">=</span> <span class="n">from_transactions</span><span class="p">(</span><span class="n">df_long</span><span class="p">,</span> <span class="n">transaction_col</span><span class="o">=</span><span class="s2">&quot;receipt_id&quot;</span><span class="p">,</span> <span class="n">item_col</span><span class="o">=</span><span class="s2">&quot;product&quot;</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="find-frequent-product-combinations">Find frequent product combinations<a class="headerlink" href="#find-frequent-product-combinations" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rusket</span><span class="w"> </span><span class="kn">import</span> <span class="n">mine</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="c1"># Keep combinations appearing in ‚â•5% of receipts</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="n">freq</span> <span class="o">=</span> <span class="n">mine</span><span class="p">(</span><span class="n">basket</span><span class="p">,</span> <span class="n">min_support</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">use_colnames</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> frequent product combinations&quot;</span><span class="p">)</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="n">top_combos</span> <span class="o">=</span> <span class="n">freq</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;support&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="nb">print</span><span class="p">(</span><span class="n">top_combos</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="c1"># e.g. (Milk,) 55%, (Bread,) 52%, (Milk, Bread) 28% ...</span>
</span></code></pre></div>
<h3 id="generate-cross-sell-rules">Generate cross-sell rules<a class="headerlink" href="#generate-cross-sell-rules" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rusket</span><span class="w"> </span><span class="kn">import</span> <span class="n">association_rules</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="n">rules</span> <span class="o">=</span> <span class="n">association_rules</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">num_itemsets</span><span class="o">=</span><span class="n">n_receipts</span><span class="p">,</span> <span class="n">min_threshold</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="c1"># Filter for actionable rules: high confidence AND lift (better than random)</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="n">actionable</span> <span class="o">=</span> <span class="n">rules</span><span class="p">[(</span><span class="n">rules</span><span class="p">[</span><span class="s2">&quot;confidence&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.45</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">rules</span><span class="p">[</span><span class="s2">&quot;lift&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.2</span><span class="p">)]</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="nb">print</span><span class="p">(</span><span class="n">actionable</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;lift&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="c1"># antecedents     consequents   confidence  lift</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="c1"># (Butter,)       (Bread,)      0.72        1.38   ‚Üí 72% of Butter buyers also buy Bread</span>
</span></code></pre></div>
<h3 id="limit-itemset-length-for-large-catalogues">Limit itemset length for large catalogues<a class="headerlink" href="#limit-itemset-length-for-large-catalogues" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1"># For a full supermarket with 5000 SKUs: cap at pairs and triples to avoid explosion</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="n">freq_pairs</span> <span class="o">=</span> <span class="n">mine</span><span class="p">(</span><span class="n">basket</span><span class="p">,</span> <span class="n">min_support</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">max_len</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">use_colnames</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<h2 id="2-eclat-when-to-use-vs-fpgrowth">2. ECLAT ‚Äî When to Use vs FPGrowth<a class="headerlink" href="#2-eclat-when-to-use-vs-fpgrowth" title="Permanent link">&para;</a></h2>
<p>ECLAT uses a vertical bitset representation. It is <strong>faster than FPGrowth for sparse datasets</strong> with many unique items and a low support threshold.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="n">fi_ec</span> <span class="o">=</span> <span class="n">eclat</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">min_support</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">use_colnames</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></code></pre></div>
<p><strong>Rule of thumb:</strong></p>
<table>
<thead>
<tr>
<th>Condition</th>
<th>Recommended algorithm</th>
</tr>
</thead>
<tbody>
<tr>
<td>Dense dataset, few items</td>
<td><code>mine(method="auto")</code></td>
</tr>
<tr>
<td>Sparse dataset, many items, low support</td>
<td><code>mine(method="auto")</code></td>
</tr>
<tr>
<td>Very large dataset (100M+ rows)</td>
<td><code>FPMiner</code> with streaming</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="3-transaction-helpers">3. Transaction Helpers<a class="headerlink" href="#3-transaction-helpers" title="Permanent link">&para;</a></h2>
<p>Convert long-format order data (e.g., from a database) to the one-hot boolean matrix format required by <code>mine</code> (which automatically routes to <code>fpgrowth</code> or <code>eclat</code>).</p>
<h3 id="from-a-pandas-dataframe">From a Pandas DataFrame<a class="headerlink" href="#from-a-pandas-dataframe" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rusket</span><span class="w"> </span><span class="kn">import</span> <span class="n">from_transactions</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="n">orders</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>    <span class="s2">&quot;order_id&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>    <span class="s2">&quot;item&quot;</span><span class="p">:</span>     <span class="p">[</span><span class="s2">&quot;Milk&quot;</span><span class="p">,</span> <span class="s2">&quot;Bread&quot;</span><span class="p">,</span> <span class="s2">&quot;Eggs&quot;</span><span class="p">,</span> <span class="s2">&quot;Milk&quot;</span><span class="p">,</span> <span class="s2">&quot;Butter&quot;</span><span class="p">,</span> <span class="s2">&quot;Eggs&quot;</span><span class="p">],</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="p">})</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="c1"># Converts long-format ‚Üí wide boolean matrix</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="n">basket</span> <span class="o">=</span> <span class="n">from_transactions</span><span class="p">(</span><span class="n">orders</span><span class="p">,</span> <span class="n">user_col</span><span class="o">=</span><span class="s2">&quot;order_id&quot;</span><span class="p">,</span> <span class="n">item_col</span><span class="o">=</span><span class="s2">&quot;item&quot;</span><span class="p">)</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="n">fi</span> <span class="o">=</span> <span class="n">mine</span><span class="p">(</span><span class="n">basket</span><span class="p">,</span> <span class="n">min_support</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">use_colnames</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="from-a-polars-dataframe">From a Polars DataFrame<a class="headerlink" href="#from-a-polars-dataframe" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="n">orders_pl</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>    <span class="s2">&quot;order_id&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>    <span class="s2">&quot;item&quot;</span><span class="p">:</span>     <span class="p">[</span><span class="s2">&quot;Milk&quot;</span><span class="p">,</span> <span class="s2">&quot;Bread&quot;</span><span class="p">,</span> <span class="s2">&quot;Eggs&quot;</span><span class="p">,</span> <span class="s2">&quot;Milk&quot;</span><span class="p">,</span> <span class="s2">&quot;Butter&quot;</span><span class="p">,</span> <span class="s2">&quot;Eggs&quot;</span><span class="p">],</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="p">})</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="n">basket</span> <span class="o">=</span> <span class="n">from_transactions</span><span class="p">(</span><span class="n">orders_pl</span><span class="p">,</span> <span class="n">user_col</span><span class="o">=</span><span class="s2">&quot;order_id&quot;</span><span class="p">,</span> <span class="n">item_col</span><span class="o">=</span><span class="s2">&quot;item&quot;</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="from-a-spark-dataframe">From a Spark DataFrame<a class="headerlink" href="#from-a-spark-dataframe" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1"># Works with PySpark DataFrames via .toPandas() under the hood</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="n">basket</span> <span class="o">=</span> <span class="n">from_transactions</span><span class="p">(</span><span class="n">spark_df</span><span class="p">,</span> <span class="n">user_col</span><span class="o">=</span><span class="s2">&quot;order_id&quot;</span><span class="p">,</span> <span class="n">item_col</span><span class="o">=</span><span class="s2">&quot;item&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<h2 id="4-collaborative-filtering-with-als-for-you-personalisation">4. Collaborative Filtering with ALS ‚Äî "For You" Personalisation<a class="headerlink" href="#4-collaborative-filtering-with-als-for-you-personalisation" title="Permanent link">&para;</a></h2>
<p><code>ALS</code> (Alternating Least Squares) learns latent user and item embeddings from <strong>implicit feedback</strong> (purchases, clicks, plays) and enables personalised "For You" recommendations.</p>
<h3 id="business-context_1">Business context<a class="headerlink" href="#business-context_1" title="Permanent link">&para;</a></h3>
<p>An e-commerce platform wants to show a personalised homepage to each logged-in user. ALS learns from past purchase history which categories of products each user affinity group prefers ‚Äî without any explicit ratings.</p>
<h3 id="fit-from-purchase-history-event-log">Fit from purchase history (event log)<a class="headerlink" href="#fit-from-purchase-history-event-log" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rusket</span><span class="w"> </span><span class="kn">import</span> <span class="n">ALS</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="c1"># Purchase history from your order management system</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="n">purchases</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>    <span class="s2">&quot;customer_id&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1001</span><span class="p">,</span> <span class="mi">1001</span><span class="p">,</span> <span class="mi">1001</span><span class="p">,</span> <span class="mi">1002</span><span class="p">,</span> <span class="mi">1002</span><span class="p">,</span> <span class="mi">1003</span><span class="p">,</span> <span class="mi">1003</span><span class="p">,</span> <span class="mi">1003</span><span class="p">],</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>    <span class="s2">&quot;sku&quot;</span><span class="p">:</span>         <span class="p">[</span><span class="s2">&quot;A10&quot;</span><span class="p">,</span> <span class="s2">&quot;B22&quot;</span><span class="p">,</span> <span class="s2">&quot;C15&quot;</span><span class="p">,</span>  <span class="s2">&quot;A10&quot;</span><span class="p">,</span> <span class="s2">&quot;D33&quot;</span><span class="p">,</span>  <span class="s2">&quot;B22&quot;</span><span class="p">,</span> <span class="s2">&quot;C15&quot;</span><span class="p">,</span> <span class="s2">&quot;E07&quot;</span><span class="p">],</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>    <span class="s2">&quot;revenue&quot;</span><span class="p">:</span>     <span class="p">[</span><span class="mf">29.99</span><span class="p">,</span> <span class="mf">49.00</span><span class="p">,</span> <span class="mf">9.99</span><span class="p">,</span>  <span class="mf">29.99</span><span class="p">,</span> <span class="mf">15.00</span><span class="p">,</span> <span class="mf">49.00</span><span class="p">,</span> <span class="mf">9.99</span><span class="p">,</span> <span class="mf">22.00</span><span class="p">],</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="p">})</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="c1"># revenue used as confidence weight (alpha scaling)</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="n">model</span> <span class="o">=</span> <span class="n">ALS</span><span class="p">(</span><span class="n">factors</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">40.0</span><span class="p">,</span> <span class="n">cg_iters</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="n">model</span> <span class="o">=</span> <span class="n">ALS</span><span class="o">.</span><span class="n">from_transactions</span><span class="p">(</span>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>    <span class="n">purchases</span><span class="p">,</span>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>    <span class="n">transaction_col</span><span class="o">=</span><span class="s2">&quot;customer_id&quot;</span><span class="p">,</span>
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a>    <span class="n">item_col</span><span class="o">=</span><span class="s2">&quot;sku&quot;</span><span class="p">,</span>
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a>    <span class="n">rating_col</span><span class="o">=</span><span class="s2">&quot;revenue&quot;</span><span class="p">,</span>
</span><span id="__span-10-17"><a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a><span class="p">)</span>
</span></code></pre></div>
<h3 id="get-personalised-recommendations">Get personalised recommendations<a class="headerlink" href="#get-personalised-recommendations" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="c1"># Top-5 SKUs for customer 1002, excluding already-purchased items</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="n">skus</span><span class="p">,</span> <span class="n">scores</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">recommend_items</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="mi">1002</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">exclude_seen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recommended SKUs for customer 1002: </span><span class="si">{</span><span class="n">skus</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="c1"># Target: which customers should receive a promo for SKU B22 (high-margin item)?</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="n">top_customers</span><span class="p">,</span> <span class="n">scores</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">recommend_users</span><span class="p">(</span><span class="n">item_id</span><span class="o">=</span><span class="s2">&quot;B22&quot;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Top customers to target with B22 promo: </span><span class="si">{</span><span class="n">top_customers</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="fit-from-transaction-data">Fit from transaction data<a class="headerlink" href="#fit-from-transaction-data" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="c1"># If you have pre-built purchase integers from your warehouse:</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="n">model2</span> <span class="o">=</span> <span class="n">ALS</span><span class="p">(</span><span class="n">factors</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="n">model2</span> <span class="o">=</span> <span class="n">ALS</span><span class="o">.</span><span class="n">from_transactions</span><span class="p">(</span><span class="n">purchases</span><span class="p">,</span> <span class="n">transaction_col</span><span class="o">=</span><span class="s2">&quot;customer_id&quot;</span><span class="p">,</span> <span class="n">item_col</span><span class="o">=</span><span class="s2">&quot;sku&quot;</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="access-latent-factors-directly">Access latent factors directly<a class="headerlink" href="#access-latent-factors-directly" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c1"># NumPy arrays (n_users √ó factors) and (n_items √ó factors)</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">user_factors</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>  <span class="c1"># (10000, 64)</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">item_factors</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>  <span class="c1"># (5000, 64)</span>
</span></code></pre></div>
<hr />
<h2 id="5-out-of-core-als-for-1b-ratings">5. Out-of-Core ALS for 1B+ Ratings<a class="headerlink" href="#5-out-of-core-als-for-1b-ratings" title="Permanent link">&para;</a></h2>
<p>When the interaction matrix exceeds available RAM, use the out-of-core streaming loader. The CSR matrix is stored on SSD and the OS pages data into RAM on demand.</p>
<h3 id="download-and-prepare-the-movielens-1b-dataset">Download and prepare the MovieLens 1B dataset<a class="headerlink" href="#download-and-prepare-the-movielens-1b-dataset" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">urllib.request</span><span class="o">,</span><span class="w"> </span><span class="nn">tarfile</span><span class="o">,</span><span class="w"> </span><span class="nn">os</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="c1"># Download (~1.4 GB)</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://files.grouplens.org/datasets/movielens/ml-20mx16x32.tar&quot;</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s2">&quot;ml-1b.tar&quot;</span><span class="p">)</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;ml-1b.tar&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>    <span class="n">t</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="s2">&quot;data/ml-1b/&quot;</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="build-the-out-of-core-csr-matrix">Build the out-of-core CSR matrix<a class="headerlink" href="#build-the-out-of-core-csr-matrix" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">sparse</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="n">data_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;data/ml-1b/ml-20mx16x32&quot;</span><span class="p">)</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="n">npz_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">data_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;trainx*.npz&quot;</span><span class="p">))</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="c1"># Pass 1 ‚Äî count ratings per user</span>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="n">max_user</span><span class="p">,</span> <span class="n">max_item</span><span class="p">,</span> <span class="n">nnz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">100_000_000</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>  <span class="c1"># pre-allocate for max users</span>
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">npz_files</span><span class="p">:</span>
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="s2">&quot;arr_0&quot;</span><span class="p">]</span>          <span class="c1"># shape (N, 2) ‚Äî [user_id, item_id]</span>
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a>    <span class="n">uids</span><span class="p">,</span> <span class="n">iids</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">arr</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a>    <span class="n">max_user</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_user</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">uids</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a>    <span class="n">max_item</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_item</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">iids</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a>    <span class="n">chunk_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">uids</span><span class="p">,</span> <span class="n">minlength</span><span class="o">=</span><span class="n">max_user</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a>    <span class="n">counts</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">chunk_counts</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">chunk_counts</span>
</span><span id="__span-15-19"><a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a>    <span class="n">nnz</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">uids</span><span class="p">)</span>
</span><span id="__span-15-20"><a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a>
</span><span id="__span-15-21"><a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a><span class="n">n_users</span><span class="p">,</span> <span class="n">n_items</span> <span class="o">=</span> <span class="n">max_user</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max_item</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="__span-15-22"><a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a><span class="n">indptr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_users</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="__span-15-23"><a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">counts</span><span class="p">[:</span><span class="n">n_users</span><span class="p">],</span> <span class="n">out</span><span class="o">=</span><span class="n">indptr</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</span><span id="__span-15-24"><a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a>
</span><span id="__span-15-25"><a id="__codelineno-15-25" name="__codelineno-15-25" href="#__codelineno-15-25"></a><span class="c1"># Pass 2 ‚Äî write indices/data to SSD memory maps</span>
</span><span id="__span-15-26"><a id="__codelineno-15-26" name="__codelineno-15-26" href="#__codelineno-15-26"></a><span class="n">mmap_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="s2">&quot;indices.mmap&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w+&quot;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nnz</span><span class="p">,))</span>
</span><span id="__span-15-27"><a id="__codelineno-15-27" name="__codelineno-15-27" href="#__codelineno-15-27"></a><span class="n">mmap_data</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="s2">&quot;data.mmap&quot;</span><span class="p">,</span>    <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w+&quot;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">nnz</span><span class="p">,))</span>
</span><span id="__span-15-28"><a id="__codelineno-15-28" name="__codelineno-15-28" href="#__codelineno-15-28"></a><span class="n">pos</span> <span class="o">=</span> <span class="n">indptr</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-15-29"><a id="__codelineno-15-29" name="__codelineno-15-29" href="#__codelineno-15-29"></a>
</span><span id="__span-15-30"><a id="__codelineno-15-30" name="__codelineno-15-30" href="#__codelineno-15-30"></a><span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">npz_files</span><span class="p">:</span>
</span><span id="__span-15-31"><a id="__codelineno-15-31" name="__codelineno-15-31" href="#__codelineno-15-31"></a>    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="s2">&quot;arr_0&quot;</span><span class="p">]</span>
</span><span id="__span-15-32"><a id="__codelineno-15-32" name="__codelineno-15-32" href="#__codelineno-15-32"></a>    <span class="n">uids</span><span class="p">,</span> <span class="n">iids</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span> <span class="n">arr</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
</span><span id="__span-15-33"><a id="__codelineno-15-33" name="__codelineno-15-33" href="#__codelineno-15-33"></a>    <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">uids</span><span class="p">,</span> <span class="n">iids</span><span class="p">):</span>
</span><span id="__span-15-34"><a id="__codelineno-15-34" name="__codelineno-15-34" href="#__codelineno-15-34"></a>        <span class="n">p</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">u</span><span class="p">]</span>
</span><span id="__span-15-35"><a id="__codelineno-15-35" name="__codelineno-15-35" href="#__codelineno-15-35"></a>        <span class="n">mmap_indices</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
</span><span id="__span-15-36"><a id="__codelineno-15-36" name="__codelineno-15-36" href="#__codelineno-15-36"></a>        <span class="n">mmap_data</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>    <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="__span-15-37"><a id="__codelineno-15-37" name="__codelineno-15-37" href="#__codelineno-15-37"></a>        <span class="n">pos</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-15-38"><a id="__codelineno-15-38" name="__codelineno-15-38" href="#__codelineno-15-38"></a>
</span><span id="__span-15-39"><a id="__codelineno-15-39" name="__codelineno-15-39" href="#__codelineno-15-39"></a><span class="n">mmap_indices</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</span><span id="__span-15-40"><a id="__codelineno-15-40" name="__codelineno-15-40" href="#__codelineno-15-40"></a><span class="n">mmap_data</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</span></code></pre></div>
<h3 id="fit-als-on-the-out-of-core-matrix">Fit ALS on the out-of-core matrix<a class="headerlink" href="#fit-als-on-the-out-of-core-matrix" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="c1"># Bypass scipy&#39;s int32 limits by direct property assignment</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="n">mat</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">((</span><span class="n">n_users</span><span class="p">,</span> <span class="n">n_items</span><span class="p">))</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="n">mat</span><span class="o">.</span><span class="n">indptr</span>  <span class="o">=</span> <span class="n">indptr</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="n">mat</span><span class="o">.</span><span class="n">indices</span> <span class="o">=</span> <span class="n">mmap_indices</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="n">mat</span><span class="o">.</span><span class="n">data</span>    <span class="o">=</span> <span class="n">mmap_data</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="n">model</span> <span class="o">=</span> <span class="n">ALS</span><span class="p">(</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>    <span class="n">factors</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>    <span class="n">iterations</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>      <span class="c1"># fewer iterations for 1B ‚Äî each takes hours on SSD</span>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a>    <span class="n">alpha</span><span class="o">=</span><span class="mf">40.0</span><span class="p">,</span>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a>    <span class="n">cg_iters</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a><span class="p">)</span>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
</span></code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Hardware sizing</p>
<p>On a machine with ‚â• 32 GB RAM the mmap working set stays hot in OS page cache and each iteration completes in ~5 minutes. On 8 GB RAM each iteration is disk-bound and takes hours.</p>
</div>
<hr />
<hr />
<h2 id="6-bayesian-personalized-ranking-bpr">6. Bayesian Personalized Ranking (BPR)<a class="headerlink" href="#6-bayesian-personalized-ranking-bpr" title="Permanent link">&para;</a></h2>
<p>Unlike ALS which tries to reconstruct the full interaction matrix, BPR explicitly optimizes the model to rank positive observed items higher than unobserved items. This makes BPR excellent for top-N ranking tasks on implicit data (like clicks or views).</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rusket</span><span class="w"> </span><span class="kn">import</span> <span class="n">BPR</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.sparse</span><span class="w"> </span><span class="kn">import</span> <span class="n">csr_matrix</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="c1"># Prepare sparse interaction matrix</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="n">rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">5000</span><span class="p">)</span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="n">cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">5000</span><span class="p">)</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="n">mat</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">5000</span><span class="p">),</span> <span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">)),</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">500</span><span class="p">))</span>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="c1"># Initialize and fit BPR with Hogwild! parallel SGD</span>
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="n">model</span> <span class="o">=</span> <span class="n">BPR</span><span class="p">(</span>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a>    <span class="n">factors</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a>    <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a>    <span class="n">regularization</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
</span><span id="__span-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a>    <span class="n">iterations</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
</span><span id="__span-17-16"><a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a>    <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
</span><span id="__span-17-17"><a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a><span class="p">)</span>
</span><span id="__span-17-18"><a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
</span><span id="__span-17-19"><a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a>
</span><span id="__span-17-20"><a id="__codelineno-17-20" name="__codelineno-17-20" href="#__codelineno-17-20"></a><span class="c1"># Recommend items just like ALS</span>
</span><span id="__span-17-21"><a id="__codelineno-17-21" name="__codelineno-17-21" href="#__codelineno-17-21"></a><span class="n">items</span><span class="p">,</span> <span class="n">scores</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">recommend_items</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<h2 id="7-sequential-pattern-mining-prefixspan">7. Sequential Pattern Mining (PrefixSpan)<a class="headerlink" href="#7-sequential-pattern-mining-prefixspan" title="Permanent link">&para;</a></h2>
<p>PrefixSpan discovers frequent sequences of events over time. Unlike standard market basket analysis (which looks at what is bought <em>together</em>), PrefixSpan finds patterns <em>across ordered events</em> ‚Äî ideal for customer journey analysis, funnel optimisation, and churn prediction.</p>
<p><strong>Business scenario:</strong> A SaaS company wants to understand which product page navigation sequences lead customers to checkout. Which paths are most common? Where do users drop off?</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rusket</span><span class="w"> </span><span class="kn">import</span> <span class="n">prefixspan</span><span class="p">,</span> <span class="n">sequences_from_event_log</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="c1"># 1. Website clickstream log ‚Äî each row is one page visit</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="n">clickstream</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>    <span class="s2">&quot;session_id&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a>    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span>  <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">40</span><span class="p">],</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a>    <span class="s2">&quot;page&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a>        <span class="s2">&quot;Home&quot;</span><span class="p">,</span> <span class="s2">&quot;Pricing&quot;</span><span class="p">,</span> <span class="s2">&quot;Checkout&quot;</span><span class="p">,</span>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a>        <span class="s2">&quot;Home&quot;</span><span class="p">,</span> <span class="s2">&quot;Pricing&quot;</span><span class="p">,</span>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a>        <span class="s2">&quot;Features&quot;</span><span class="p">,</span> <span class="s2">&quot;Pricing&quot;</span><span class="p">,</span> <span class="s2">&quot;Checkout&quot;</span><span class="p">,</span>
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a>        <span class="s2">&quot;Home&quot;</span><span class="p">,</span> <span class="s2">&quot;Features&quot;</span><span class="p">,</span> <span class="s2">&quot;Checkout&quot;</span><span class="p">,</span>
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a>    <span class="p">],</span>
</span><span id="__span-18-14"><a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a><span class="p">})</span>
</span><span id="__span-18-15"><a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a>
</span><span id="__span-18-16"><a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a><span class="c1"># 2. Convert to sequence format expected by the Rust miner</span>
</span><span id="__span-18-17"><a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a><span class="n">seqs</span><span class="p">,</span> <span class="n">mapping</span> <span class="o">=</span> <span class="n">sequences_from_event_log</span><span class="p">(</span>
</span><span id="__span-18-18"><a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a>    <span class="n">clickstream</span><span class="p">,</span> <span class="n">user_col</span><span class="o">=</span><span class="s2">&quot;session_id&quot;</span><span class="p">,</span> <span class="n">time_col</span><span class="o">=</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="n">item_col</span><span class="o">=</span><span class="s2">&quot;page&quot;</span>
</span><span id="__span-18-19"><a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a><span class="p">)</span>
</span><span id="__span-18-20"><a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a>
</span><span id="__span-18-21"><a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a><span class="c1"># 3. Mine navigation sequences seen in ‚â•2 sessions (absolute count)</span>
</span><span id="__span-18-22"><a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a><span class="n">patterns_df</span> <span class="o">=</span> <span class="n">prefixspan</span><span class="p">(</span><span class="n">seqs</span><span class="p">,</span> <span class="n">min_support</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">max_len</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</span><span id="__span-18-23"><a id="__codelineno-18-23" name="__codelineno-18-23" href="#__codelineno-18-23"></a>
</span><span id="__span-18-24"><a id="__codelineno-18-24" name="__codelineno-18-24" href="#__codelineno-18-24"></a><span class="c1"># 4. Map integer IDs back to readable page names</span>
</span><span id="__span-18-25"><a id="__codelineno-18-25" name="__codelineno-18-25" href="#__codelineno-18-25"></a><span class="n">patterns_df</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">patterns_df</span><span class="p">[</span><span class="s2">&quot;sequence&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
</span><span id="__span-18-26"><a id="__codelineno-18-26" name="__codelineno-18-26" href="#__codelineno-18-26"></a>    <span class="k">lambda</span> <span class="n">seq</span><span class="p">:</span> <span class="s2">&quot; ‚Üí &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">seq</span><span class="p">)</span>
</span><span id="__span-18-27"><a id="__codelineno-18-27" name="__codelineno-18-27" href="#__codelineno-18-27"></a><span class="p">)</span>
</span><span id="__span-18-28"><a id="__codelineno-18-28" name="__codelineno-18-28" href="#__codelineno-18-28"></a><span class="nb">print</span><span class="p">(</span><span class="n">patterns_df</span><span class="p">[[</span><span class="s2">&quot;support&quot;</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;support&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
</span><span id="__span-18-29"><a id="__codelineno-18-29" name="__codelineno-18-29" href="#__codelineno-18-29"></a><span class="c1"># support  path</span>
</span><span id="__span-18-30"><a id="__codelineno-18-30" name="__codelineno-18-30" href="#__codelineno-18-30"></a><span class="c1"># 3        Home</span>
</span><span id="__span-18-31"><a id="__codelineno-18-31" name="__codelineno-18-31" href="#__codelineno-18-31"></a><span class="c1"># 3        Pricing</span>
</span><span id="__span-18-32"><a id="__codelineno-18-32" name="__codelineno-18-32" href="#__codelineno-18-32"></a><span class="c1"># 3        Checkout</span>
</span><span id="__span-18-33"><a id="__codelineno-18-33" name="__codelineno-18-33" href="#__codelineno-18-33"></a><span class="c1"># 3        Home ‚Üí Pricing</span>
</span><span id="__span-18-34"><a id="__codelineno-18-34" name="__codelineno-18-34" href="#__codelineno-18-34"></a><span class="c1"># 3        Pricing ‚Üí Checkout</span>
</span><span id="__span-18-35"><a id="__codelineno-18-35" name="__codelineno-18-35" href="#__codelineno-18-35"></a><span class="c1"># 2        Home ‚Üí Checkout                  ‚Üê users who skipped Pricing</span>
</span><span id="__span-18-36"><a id="__codelineno-18-36" name="__codelineno-18-36" href="#__codelineno-18-36"></a><span class="c1"># 2        Features ‚Üí Pricing ‚Üí Checkout   ‚Üê high-intent funnel path</span>
</span></code></pre></div>
<hr />
<h2 id="8-high-utility-pattern-mining-hupm-profit-driven-bundle-discovery">8. High-Utility Pattern Mining (HUPM) ‚Äî Profit-Driven Bundle Discovery<a class="headerlink" href="#8-high-utility-pattern-mining-hupm-profit-driven-bundle-discovery" title="Permanent link">&para;</a></h2>
<p>Frequent itemsets aren't always the most profitable. HUPM accounts for the <strong>utility</strong> (e.g., margin, revenue, quantity √ó price) of items to find sets that generate the <em>highest total business value</em> ‚Äî even if they appear infrequently.</p>
<p><strong>Business scenario:</strong> A wine shop wants to identify high-margin product bundles for a "Sommelier's Selection" gift box. Standard FP-Growth would surface budget items (e.g., sparkling water) because they're bought often. HUPM surfaces the highest-revenue product combinations instead:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rusket</span><span class="w"> </span><span class="kn">import</span> <span class="n">HUPM</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="c1"># Receipt data from the EPOS system ‚Äî product_id and margin per line item</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="n">receipts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a>    <span class="s2">&quot;receipt_id&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a>    <span class="s2">&quot;product&quot;</span><span class="p">:</span>    <span class="p">[</span><span class="s2">&quot;champagne&quot;</span><span class="p">,</span> <span class="s2">&quot;foie_gras&quot;</span><span class="p">,</span> <span class="s2">&quot;truffle_oil&quot;</span><span class="p">,</span>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a>                   <span class="s2">&quot;champagne&quot;</span><span class="p">,</span> <span class="s2">&quot;truffle_oil&quot;</span><span class="p">,</span>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a>                   <span class="s2">&quot;foie_gras&quot;</span><span class="p">,</span> <span class="s2">&quot;truffle_oil&quot;</span><span class="p">,</span>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a>                   <span class="s2">&quot;champagne&quot;</span><span class="p">,</span> <span class="s2">&quot;foie_gras&quot;</span><span class="p">,</span> <span class="s2">&quot;truffle_oil&quot;</span><span class="p">],</span>
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a>    <span class="s2">&quot;margin&quot;</span><span class="p">:</span>     <span class="p">[</span><span class="mf">18.50</span><span class="p">,</span> <span class="mf">14.00</span><span class="p">,</span> <span class="mf">8.00</span><span class="p">,</span>   <span class="c1"># receipt 1 margins</span>
</span><span id="__span-19-13"><a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a>                   <span class="mf">18.50</span><span class="p">,</span> <span class="mf">8.00</span><span class="p">,</span>            <span class="c1"># receipt 2</span>
</span><span id="__span-19-14"><a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a>                   <span class="mf">14.00</span><span class="p">,</span> <span class="mf">8.00</span><span class="p">,</span>            <span class="c1"># receipt 3</span>
</span><span id="__span-19-15"><a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a>                   <span class="mf">18.50</span><span class="p">,</span> <span class="mf">14.00</span><span class="p">,</span> <span class="mf">8.00</span><span class="p">],</span>    <span class="c1"># receipt 4</span>
</span><span id="__span-19-16"><a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a><span class="p">})</span>
</span><span id="__span-19-17"><a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a>
</span><span id="__span-19-18"><a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a><span class="c1"># Discover all product bundles generating ‚â• ‚Ç¨30 total margin</span>
</span><span id="__span-19-19"><a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a><span class="n">high_value</span> <span class="o">=</span> <span class="n">HUPM</span><span class="o">.</span><span class="n">from_transactions</span><span class="p">(</span>
</span><span id="__span-19-20"><a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a>    <span class="n">receipts</span><span class="p">,</span>
</span><span id="__span-19-21"><a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a>    <span class="n">transaction_col</span><span class="o">=</span><span class="s2">&quot;receipt_id&quot;</span><span class="p">,</span>
</span><span id="__span-19-22"><a id="__codelineno-19-22" name="__codelineno-19-22" href="#__codelineno-19-22"></a>    <span class="n">item_col</span><span class="o">=</span><span class="s2">&quot;product&quot;</span><span class="p">,</span>
</span><span id="__span-19-23"><a id="__codelineno-19-23" name="__codelineno-19-23" href="#__codelineno-19-23"></a>    <span class="n">utility_col</span><span class="o">=</span><span class="s2">&quot;margin&quot;</span><span class="p">,</span>
</span><span id="__span-19-24"><a id="__codelineno-19-24" name="__codelineno-19-24" href="#__codelineno-19-24"></a>    <span class="n">min_utility</span><span class="o">=</span><span class="mf">30.0</span><span class="p">,</span>
</span><span id="__span-19-25"><a id="__codelineno-19-25" name="__codelineno-19-25" href="#__codelineno-19-25"></a><span class="p">)</span><span class="o">.</span><span class="n">mine</span><span class="p">()</span>
</span><span id="__span-19-26"><a id="__codelineno-19-26" name="__codelineno-19-26" href="#__codelineno-19-26"></a>
</span><span id="__span-19-27"><a id="__codelineno-19-27" name="__codelineno-19-27" href="#__codelineno-19-27"></a><span class="nb">print</span><span class="p">(</span><span class="n">high_value</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;utility&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</span><span id="__span-19-28"><a id="__codelineno-19-28" name="__codelineno-19-28" href="#__codelineno-19-28"></a><span class="c1"># utility   itemset</span>
</span><span id="__span-19-29"><a id="__codelineno-19-29" name="__codelineno-19-29" href="#__codelineno-19-29"></a><span class="c1"># 122.0     [champagne, foie_gras, truffle_oil]  ‚Üê ideal gift box</span>
</span><span id="__span-19-30"><a id="__codelineno-19-30" name="__codelineno-19-30" href="#__codelineno-19-30"></a><span class="c1"># 74.0      [champagne, foie_gras]</span>
</span><span id="__span-19-31"><a id="__codelineno-19-31" name="__codelineno-19-31" href="#__codelineno-19-31"></a><span class="c1"># 62.0      [champagne, truffle_oil]</span>
</span></code></pre></div>
<hr />
<h2 id="9-native-polars-integration">9. Native Polars Integration<a class="headerlink" href="#9-native-polars-integration" title="Permanent link">&para;</a></h2>
<p><code>rusket</code> returns itemsets as zero-copy <strong>PyArrow <code>ListArray</code></strong> structures, making Polars interoperability very efficient.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="n">df_pl</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="n">fi_pl</span> <span class="o">=</span> <span class="n">mine</span><span class="p">(</span><span class="n">df_pl</span><span class="p">,</span> <span class="n">min_support</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">use_colnames</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="c1"># LazyFrame works too:</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="n">lazy</span> <span class="o">=</span> <span class="n">df_pl</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="c1"># (convert to eager first before passing to fpgrowth)</span>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="n">fi_pl2</span> <span class="o">=</span> <span class="n">mine</span><span class="p">(</span><span class="n">lazy</span><span class="o">.</span><span class="n">collect</span><span class="p">(),</span> <span class="n">min_support</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">use_colnames</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="query-itemsets-with-pyarrow-compute">Query itemsets with PyArrow compute<a class="headerlink" href="#query-itemsets-with-pyarrow-compute" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pyarrow.compute</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pc</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="c1"># Find itemsets containing &quot;Milk&quot; as first element</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="n">contains_milk</span> <span class="o">=</span> <span class="n">pc</span><span class="o">.</span><span class="n">list_element</span><span class="p">(</span><span class="n">fi</span><span class="p">[</span><span class="s2">&quot;itemsets&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;Milk&quot;</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="n">fi</span><span class="p">[</span><span class="n">contains_milk</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</span></code></pre></div>
<h3 id="convert-to-python-sets-only-for-small-subsets">Convert to Python sets (only for small subsets)<a class="headerlink" href="#convert-to-python-sets-only-for-small-subsets" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="n">top_10</span> <span class="o">=</span> <span class="n">fi</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="n">top_10</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">top_10</span><span class="p">[</span><span class="s2">&quot;itemsets&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<h2 id="10-spark-databricks-integration">10. Spark / Databricks Integration<a class="headerlink" href="#10-spark-databricks-integration" title="Permanent link">&para;</a></h2>
<p><code>rusket</code> provides native integration with PySpark out of the box, leaning heavily on <strong>Apache Arrow</strong> to completely bypass Python-to-JVM serialization and Pandas memory bloat.</p>
<h3 id="101-streaming-1b-rows-from-spark-zero-copy">10.1 Streaming 1B+ Rows from Spark (Zero-Copy)<a class="headerlink" href="#101-streaming-1b-rows-from-spark-zero-copy" title="Permanent link">&para;</a></h3>
<p>Instead of using <code>.toPandas()</code> (which will OOM driver nodes instantly on large tables), use <code>mine_spark</code>, which streams Arrow partitions dynamically.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rusket</span><span class="w"> </span><span class="kn">import</span> <span class="n">mine_spark</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="n">spark_df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s2">&quot;silver_transactions&quot;</span><span class="p">)</span>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="c1"># Streams Arrow RecordBatches directly to the Rust backend</span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a><span class="n">frequent_itemsets</span> <span class="o">=</span> <span class="n">mine_spark</span><span class="p">(</span>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>    <span class="n">spark_df</span><span class="p">,</span> 
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>    <span class="n">n_items</span><span class="o">=</span><span class="mi">500_000</span><span class="p">,</span> 
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a>    <span class="n">txn_col</span><span class="o">=</span><span class="s2">&quot;transaction_id&quot;</span><span class="p">,</span> 
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a>    <span class="n">item_col</span><span class="o">=</span><span class="s2">&quot;product_id&quot;</span><span class="p">,</span> 
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a>    <span class="n">min_support</span><span class="o">=</span><span class="mf">0.001</span>
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a><span class="p">)</span>
</span></code></pre></div>
<h3 id="102-distributed-parallel-mining-grouped">10.2 Distributed Parallel Mining (Grouped)<a class="headerlink" href="#102-distributed-parallel-mining-grouped" title="Permanent link">&para;</a></h3>
<p>If you have multi-tenant data (e.g., you want to mine <em>distinct</em> association rules per region, store, or customer segment), you can distribute <code>rusket</code> across your entire Databricks cluster using PySpark's <code>applyInArrow</code>.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rusket.spark</span><span class="w"> </span><span class="kn">import</span> <span class="n">mine_grouped</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="n">spark_df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s2">&quot;retail_transactions&quot;</span><span class="p">)</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="c1"># Rusket maps the workload across executor nodes. Each node runs pure Rust </span>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="c1"># on its Spark partition and yields the regional itemsets back.</span>
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="n">regional_rules_df</span> <span class="o">=</span> <span class="n">mine_grouped</span><span class="p">(</span>
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a>    <span class="n">spark_df</span><span class="p">,</span> 
</span><span id="__span-24-9"><a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a>    <span class="n">group_col</span><span class="o">=</span><span class="s2">&quot;store_id&quot;</span><span class="p">,</span> 
</span><span id="__span-24-10"><a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a>    <span class="n">min_support</span><span class="o">=</span><span class="mf">0.05</span>
</span><span id="__span-24-11"><a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a><span class="p">)</span>
</span><span id="__span-24-12"><a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a>
</span><span id="__span-24-13"><a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a><span class="n">display</span><span class="p">(</span><span class="n">regional_rules_df</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="103-collaborative-filtering-als-from-spark">10.3 Collaborative Filtering (ALS) from Spark<a class="headerlink" href="#103-collaborative-filtering-als-from-spark" title="Permanent link">&para;</a></h3>
<p>For recommendation workloads, you can seamlessly feed Spark DataFrames containing <code>(user, item, rating)</code> triplets into ALS.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rusket</span><span class="w"> </span><span class="kn">import</span> <span class="n">ALS</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="n">ratings_spark</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s2">&quot;implicit_ratings&quot;</span><span class="p">)</span> 
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="n">model</span> <span class="o">=</span> <span class="n">ALS</span><span class="p">(</span><span class="n">factors</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a>
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="c1"># Coerces to Pandas internally for fit (only for tables that fit in driver RAM)</span>
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="n">model</span> <span class="o">=</span> <span class="n">ALS</span><span class="o">.</span><span class="n">from_transactions</span><span class="p">(</span>
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a>    <span class="n">ratings_spark</span><span class="p">,</span> 
</span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a>    <span class="n">transaction_col</span><span class="o">=</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> 
</span><span id="__span-25-10"><a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a>    <span class="n">item_col</span><span class="o">=</span><span class="s2">&quot;item_id&quot;</span><span class="p">,</span> 
</span><span id="__span-25-11"><a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a>    <span class="n">rating_col</span><span class="o">=</span><span class="s2">&quot;clicks&quot;</span><span class="p">,</span>
</span><span id="__span-25-12"><a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a>    <span class="n">factors</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
</span><span id="__span-25-13"><a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a>    <span class="n">iterations</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span><span id="__span-25-14"><a id="__codelineno-25-14" name="__codelineno-25-14" href="#__codelineno-25-14"></a>    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span>
</span><span id="__span-25-15"><a id="__codelineno-25-15" name="__codelineno-25-15" href="#__codelineno-25-15"></a><span class="p">)</span>
</span></code></pre></div>
<div class="admonition note">
<p class="admonition-title">Out-of-Core Models</p>
<p>For Spark tables spanning &gt;100M rows, use <code>mine_spark</code> for Frequent Pattern mining, or export the table to an Out-of-Core disk map (Section 5) for ALS factorisation.</p>
</div>
<hr />
<h2 id="11-tuning-guide">11. Tuning Guide<a class="headerlink" href="#11-tuning-guide" title="Permanent link">&para;</a></h2>
<h3 id="fpgrowth-eclat">FPGrowth / ECLAT<a class="headerlink" href="#fpgrowth-eclat" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Default</th>
<th>Effect</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>min_support</code></td>
<td>required</td>
<td>Lower ‚Üí more itemsets, slower</td>
</tr>
<tr>
<td><code>max_len</code></td>
<td>None</td>
<td>Cap itemset size ‚Äî huge speedup on large catalogs</td>
</tr>
<tr>
<td><code>use_colnames</code></td>
<td>False</td>
<td>Return column names instead of indices</td>
</tr>
</tbody>
</table>
<h3 id="als">ALS<a class="headerlink" href="#als" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>factors</code></td>
<td>64</td>
<td>Higher ‚Üí better quality, more RAM, slower</td>
</tr>
<tr>
<td><code>iterations</code></td>
<td>15</td>
<td>5‚Äì15 is typical; diminishing returns after 20</td>
</tr>
<tr>
<td><code>alpha</code></td>
<td>40.0</td>
<td>Higher ‚Üí stronger signal from implicit feedback</td>
</tr>
<tr>
<td><code>regularization</code></td>
<td>0.01</td>
<td>Increase if overfitting; decrease for denser data</td>
</tr>
<tr>
<td><code>cg_iters</code></td>
<td>3</td>
<td>CG solver steps per ALS step ‚Äî 3 is almost always optimal</td>
</tr>
<tr>
<td><code>verbose</code></td>
<td>False</td>
<td>Set <code>True</code> to print per-iteration timing</td>
</tr>
</tbody>
</table>
<h3 id="bpr">BPR<a class="headerlink" href="#bpr" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>factors</code></td>
<td>64</td>
<td>Higher ‚Üí better quality, more RAM. BPR requires more factors than ALS typically</td>
</tr>
<tr>
<td><code>iterations</code></td>
<td>100</td>
<td>BPR uses SGD and requires more iterations than ALS. Try 100-500.</td>
</tr>
<tr>
<td><code>learning_rate</code></td>
<td>0.01</td>
<td>SGD learning rate. Decrease if unstable, increase if slow convergence.</td>
</tr>
<tr>
<td><code>regularization</code></td>
<td>0.01</td>
<td>Increase if overfitting</td>
</tr>
</tbody>
</table>
<h3 id="prefixspan-hupm">PrefixSpan &amp; HUPM<a class="headerlink" href="#prefixspan-hupm" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Default</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>min_support</code></td>
<td>required</td>
<td>Defines frequency for PrefixSpan or total value for HUPM</td>
</tr>
<tr>
<td><code>max_len</code></td>
<td>None</td>
<td>Cap itemset/sequence size to avoid combinatorial explosions</td>
</tr>
</tbody>
</table>
<h3 id="recommendation-quality-tips">Recommendation quality tips<a class="headerlink" href="#recommendation-quality-tips" title="Permanent link">&para;</a></h3>
<ul>
<li>Use <code>regularization=0.1</code> for very sparse matrices (&lt; 5 interactions/user)</li>
<li><code>alpha=10</code> works better for rating-weighted data vs binary implicit feedback for ALS</li>
<li>For top-N ranking optimization directly, use <strong>BPR</strong> instead of <strong>ALS</strong>. ALS is better for score prediction and serendipity.</li>
<li>For the best cold-start handling, combine ALS/BPR with popularity-based fallback</li>
<li>Lower <code>cg_iters</code> (e.g., 1‚Äì2) for faster but noisier convergence on huge ALS datasets</li>
</ul>
<hr />
<h2 id="9-sequential-pattern-mining-prefixspan">9. Sequential Pattern Mining (PrefixSpan)<a class="headerlink" href="#9-sequential-pattern-mining-prefixspan" title="Permanent link">&para;</a></h2>
<p>When the <strong>order</strong> of events matters (e.g., website navigation paths, sequential purchases over time), use PrefixSpan instead of FP-Growth.</p>
<p><code>rusket</code> has native, out-of-the-box integration for routing sequence generation across <strong>Pandas</strong>, <strong>Polars</strong>, and <strong>PySpark</strong> <code>DataFrame</code>s. It utilizes lightning-fast internal grouped maps to feed the integers into the Rust parser.</p>
<h3 id="prepare-the-event-log-pandas-polars-or-spark">Prepare the Event Log (Pandas, Polars, or Spark)<a class="headerlink" href="#prepare-the-event-log-pandas-polars-or-spark" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rusket</span><span class="w"> </span><span class="kn">import</span> <span class="n">prefixspan</span><span class="p">,</span> <span class="n">sequences_from_event_log</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="c1"># Let&#39;s say this is your PySpark, Polars, or Pandas DataFrame</span>
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="n">events</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>    <span class="s2">&quot;user_id&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a>    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>        <span class="s2">&quot;2024-01-01 10:00&quot;</span><span class="p">,</span> <span class="s2">&quot;2024-01-01 10:05&quot;</span><span class="p">,</span> <span class="s2">&quot;2024-01-01 10:10&quot;</span><span class="p">,</span>
</span><span id="__span-26-9"><a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a>        <span class="s2">&quot;2024-01-02 11:00&quot;</span><span class="p">,</span> <span class="s2">&quot;2024-01-02 11:05&quot;</span><span class="p">,</span>
</span><span id="__span-26-10"><a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a>        <span class="s2">&quot;2024-01-03 09:00&quot;</span><span class="p">,</span> <span class="s2">&quot;2024-01-03 09:05&quot;</span><span class="p">,</span> <span class="s2">&quot;2024-01-03 09:10&quot;</span>
</span><span id="__span-26-11"><a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a>    <span class="p">],</span>
</span><span id="__span-26-12"><a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a>    <span class="s2">&quot;page_id&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;home&quot;</span><span class="p">,</span> <span class="s2">&quot;products&quot;</span><span class="p">,</span> <span class="s2">&quot;checkout&quot;</span><span class="p">,</span> <span class="s2">&quot;home&quot;</span><span class="p">,</span> <span class="s2">&quot;products&quot;</span><span class="p">,</span> <span class="s2">&quot;home&quot;</span><span class="p">,</span> <span class="s2">&quot;products&quot;</span><span class="p">,</span> <span class="s2">&quot;checkout&quot;</span><span class="p">]</span>
</span><span id="__span-26-13"><a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a><span class="p">})</span>
</span><span id="__span-26-14"><a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a>
</span><span id="__span-26-15"><a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a><span class="c1"># Convert timestamp to datetime for correct sorting</span>
</span><span id="__span-26-16"><a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a><span class="n">events</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">])</span>
</span><span id="__span-26-17"><a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a>
</span><span id="__span-26-18"><a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a><span class="c1"># Convert to sequence format required by prefixspan</span>
</span><span id="__span-26-19"><a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a><span class="c1"># Passes natively to Arrow if events is a PySpark or Polars dataframe!</span>
</span><span id="__span-26-20"><a id="__codelineno-26-20" name="__codelineno-26-20" href="#__codelineno-26-20"></a><span class="n">sequences</span><span class="p">,</span> <span class="n">idx_to_item</span> <span class="o">=</span> <span class="n">sequences_from_event_log</span><span class="p">(</span>
</span><span id="__span-26-21"><a id="__codelineno-26-21" name="__codelineno-26-21" href="#__codelineno-26-21"></a>    <span class="n">events</span><span class="p">,</span> 
</span><span id="__span-26-22"><a id="__codelineno-26-22" name="__codelineno-26-22" href="#__codelineno-26-22"></a>    <span class="n">user_col</span><span class="o">=</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> 
</span><span id="__span-26-23"><a id="__codelineno-26-23" name="__codelineno-26-23" href="#__codelineno-26-23"></a>    <span class="n">time_col</span><span class="o">=</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> 
</span><span id="__span-26-24"><a id="__codelineno-26-24" name="__codelineno-26-24" href="#__codelineno-26-24"></a>    <span class="n">item_col</span><span class="o">=</span><span class="s2">&quot;page_id&quot;</span>
</span><span id="__span-26-25"><a id="__codelineno-26-25" name="__codelineno-26-25" href="#__codelineno-26-25"></a><span class="p">)</span>
</span></code></pre></div>
<h3 id="mine-sequential-patterns">Mine Sequential Patterns<a class="headerlink" href="#mine-sequential-patterns" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="c1"># min_support is an absolute number of sequences</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="n">patterns</span> <span class="o">=</span> <span class="n">prefixspan</span><span class="p">(</span><span class="n">sequences</span><span class="p">,</span> <span class="n">min_support</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">max_len</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="c1"># Map integer IDs back to original page names</span>
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="n">patterns</span><span class="p">[</span><span class="s2">&quot;sequence_names&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">[</span><span class="s2">&quot;sequence&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a>    <span class="k">lambda</span> <span class="n">seq</span><span class="p">:</span> <span class="p">[</span><span class="n">idx_to_item</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">seq</span><span class="p">]</span>
</span><span id="__span-27-7"><a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a><span class="p">)</span>
</span><span id="__span-27-8"><a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a>
</span><span id="__span-27-9"><a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a><span class="nb">print</span><span class="p">(</span><span class="n">patterns</span><span class="p">[[</span><span class="s2">&quot;support&quot;</span><span class="p">,</span> <span class="s2">&quot;sequence_names&quot;</span><span class="p">]])</span>
</span><span id="__span-27-10"><a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a><span class="c1">#    support               sequence_names</span>
</span><span id="__span-27-11"><a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a><span class="c1"># 0        3                       [home]</span>
</span><span id="__span-27-12"><a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a><span class="c1"># 1        3                   [products]</span>
</span><span id="__span-27-13"><a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a><span class="c1"># 2        3             [home, products]</span>
</span><span id="__span-27-14"><a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a><span class="c1"># 3        2                   [checkout]</span>
</span><span id="__span-27-15"><a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a><span class="c1"># 4        2             [home, checkout]</span>
</span><span id="__span-27-16"><a id="__codelineno-27-16" name="__codelineno-27-16" href="#__codelineno-27-16"></a><span class="c1"># 5        2         [products, checkout]</span>
</span><span id="__span-27-17"><a id="__codelineno-27-17" name="__codelineno-27-17" href="#__codelineno-27-17"></a><span class="c1"># 6        2   [home, products, checkout]</span>
</span></code></pre></div>
<hr />
<h2 id="10-high-utility-pattern-mining-hupm">10. High-Utility Pattern Mining (HUPM)<a class="headerlink" href="#10-high-utility-pattern-mining-hupm" title="Permanent link">&para;</a></h2>
<p>Standard Frequent Itemset Mining (FP-Growth/Eclat) treats all items equally. HUPM considers the <strong>profit</strong> or <strong>utility</strong> of items, discovering itemsets that generate high total revenue even if they are bought infrequently.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rusket</span><span class="w"> </span><span class="kn">import</span> <span class="n">hupm</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="c1"># Item IDs bought</span>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="n">transactions</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a>    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> 
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a>    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>    
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a>    <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>     
</span><span id="__span-28-8"><a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a><span class="p">]</span>
</span><span id="__span-28-9"><a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a>
</span><span id="__span-28-10"><a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a><span class="c1"># Profit (or quantity * price) of each item in the respective transaction</span>
</span><span id="__span-28-11"><a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a><span class="n">utilities</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-28-12"><a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a>    <span class="p">[</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">],</span> <span class="c1"># Transaction 1 profits</span>
</span><span id="__span-28-13"><a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a>    <span class="p">[</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">],</span>       <span class="c1"># Transaction 2 profits</span>
</span><span id="__span-28-14"><a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a>    <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">]</span>       <span class="c1"># Transaction 3 profits</span>
</span><span id="__span-28-15"><a id="__codelineno-28-15" name="__codelineno-28-15" href="#__codelineno-28-15"></a><span class="p">]</span>
</span><span id="__span-28-16"><a id="__codelineno-28-16" name="__codelineno-28-16" href="#__codelineno-28-16"></a>
</span><span id="__span-28-17"><a id="__codelineno-28-17" name="__codelineno-28-17" href="#__codelineno-28-17"></a><span class="c1"># Mine itemsets with at least 15.0 total utility</span>
</span><span id="__span-28-18"><a id="__codelineno-28-18" name="__codelineno-28-18" href="#__codelineno-28-18"></a><span class="n">high_utility_itemsets</span> <span class="o">=</span> <span class="n">hupm</span><span class="p">(</span><span class="n">transactions</span><span class="p">,</span> <span class="n">utilities</span><span class="p">,</span> <span class="n">min_utility</span><span class="o">=</span><span class="mf">15.0</span><span class="p">,</span> <span class="n">max_len</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="__span-28-19"><a id="__codelineno-28-19" name="__codelineno-28-19" href="#__codelineno-28-19"></a><span class="nb">print</span><span class="p">(</span><span class="n">high_utility_itemsets</span><span class="p">)</span>
</span><span id="__span-28-20"><a id="__codelineno-28-20" name="__codelineno-28-20" href="#__codelineno-28-20"></a><span class="c1">#    utility    itemset</span>
</span><span id="__span-28-21"><a id="__codelineno-28-21" name="__codelineno-28-21" href="#__codelineno-28-21"></a><span class="c1"># 0     20.0       [2]</span>
</span><span id="__span-28-22"><a id="__codelineno-28-22" name="__codelineno-28-22" href="#__codelineno-28-22"></a><span class="c1"># 1     24.0    [2, 3]</span>
</span><span id="__span-28-23"><a id="__codelineno-28-23" name="__codelineno-28-23" href="#__codelineno-28-23"></a><span class="c1"># 2     17.0 [1, 2, 3]</span>
</span></code></pre></div>
<hr />
<h2 id="11-bayesian-personalized-ranking-bpr">11. Bayesian Personalized Ranking (BPR)<a class="headerlink" href="#11-bayesian-personalized-ranking-bpr" title="Permanent link">&para;</a></h2>
<p>BPR is a matrix factorization model that optimizes for <strong>ranking metrics</strong> rather than reconstruction error (like ALS). It works by sampling positive (interacted) and negative (unseen) items and ensuring the positive items are ranked higher. Use it when interaction data is purely binary implicit feedback.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rusket</span><span class="w"> </span><span class="kn">import</span> <span class="n">BPR</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.sparse</span><span class="w"> </span><span class="kn">import</span> <span class="n">csr_matrix</span>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a>
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="c1"># Create an implicit feedback matrix (users x items)</span>
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a><span class="n">mat</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">])),</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</span><span id="__span-29-7"><a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a>
</span><span id="__span-29-8"><a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a><span class="n">model</span> <span class="o">=</span> <span class="n">BPR</span><span class="p">(</span>
</span><span id="__span-29-9"><a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a>    <span class="n">factors</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
</span><span id="__span-29-10"><a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a>    <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
</span><span id="__span-29-11"><a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a>    <span class="n">iterations</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
</span><span id="__span-29-12"><a id="__codelineno-29-12" name="__codelineno-29-12" href="#__codelineno-29-12"></a>    <span class="n">regularization</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
</span><span id="__span-29-13"><a id="__codelineno-29-13" name="__codelineno-29-13" href="#__codelineno-29-13"></a>    <span class="n">seed</span><span class="o">=</span><span class="mi">42</span>
</span><span id="__span-29-14"><a id="__codelineno-29-14" name="__codelineno-29-14" href="#__codelineno-29-14"></a><span class="p">)</span>
</span><span id="__span-29-15"><a id="__codelineno-29-15" name="__codelineno-29-15" href="#__codelineno-29-15"></a>
</span><span id="__span-29-16"><a id="__codelineno-29-16" name="__codelineno-29-16" href="#__codelineno-29-16"></a><span class="c1"># Fit the BPR model</span>
</span><span id="__span-29-17"><a id="__codelineno-29-17" name="__codelineno-29-17" href="#__codelineno-29-17"></a><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
</span><span id="__span-29-18"><a id="__codelineno-29-18" name="__codelineno-29-18" href="#__codelineno-29-18"></a>
</span><span id="__span-29-19"><a id="__codelineno-29-19" name="__codelineno-29-19" href="#__codelineno-29-19"></a><span class="c1"># Recommend 3 items for user 0, excluding items they already interacted with</span>
</span><span id="__span-29-20"><a id="__codelineno-29-20" name="__codelineno-29-20" href="#__codelineno-29-20"></a><span class="n">item_ids</span><span class="p">,</span> <span class="n">scores</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">recommend_items</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">exclude_seen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-29-21"><a id="__codelineno-29-21" name="__codelineno-29-21" href="#__codelineno-29-21"></a><span class="nb">print</span><span class="p">(</span><span class="n">item_ids</span><span class="p">,</span> <span class="n">scores</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<h2 id="12-item-similarity-and-cross-selling-potential">12. Item Similarity and Cross-Selling Potential<a class="headerlink" href="#12-item-similarity-and-cross-selling-potential" title="Permanent link">&para;</a></h2>
<p>Once you have fitted an ALS or BPR model, the learned latent factors are incredibly useful for measuring item similarity and predicting missed cross-sell opportunities.</p>
<h3 id="find-similar-products-item-to-item">Find Similar Products (Item-to-Item)<a class="headerlink" href="#find-similar-products-item-to-item" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rusket</span><span class="w"> </span><span class="kn">import</span> <span class="n">similar_items</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="c1"># Given an ALS model fitted on purchases</span>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="n">item_ids</span><span class="p">,</span> <span class="n">match_scores</span> <span class="o">=</span> <span class="n">similar_items</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="mi">102</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a>
</span><span id="__span-30-6"><a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Items similar to </span><span class="si">{</span><span class="mi">102</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">item_ids</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-30-7"><a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a><span class="c1"># =&gt; Items similar to 102: [105, 99, 110, 87, 10]</span>
</span></code></pre></div>
<h3 id="calculate-cross-selling-potential">Calculate Cross-Selling Potential<a class="headerlink" href="#calculate-cross-selling-potential" title="Permanent link">&para;</a></h3>
<p>Identify the probability that a user <em>should</em> have bought an item by now, but hasn't (<code>score_potential</code>).</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rusket</span><span class="w"> </span><span class="kn">import</span> <span class="n">score_potential</span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="n">user_purchase_history</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a>    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="c1"># User 0 bought items 0, 1, 5</span>
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a>    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>    <span class="c1"># User 1 bought items 1, 3</span>
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a>    <span class="p">[</span><span class="mi">0</span><span class="p">]</span>        <span class="c1"># User 2 bought item 0</span>
</span><span id="__span-31-7"><a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a><span class="p">]</span>
</span><span id="__span-31-8"><a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a>
</span><span id="__span-31-9"><a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a><span class="c1"># Provide specific categories/items you want to cross-sell</span>
</span><span id="__span-31-10"><a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a><span class="n">target_items</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>
</span><span id="__span-31-11"><a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a>
</span><span id="__span-31-12"><a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a><span class="c1"># Matrix of shape (n_users, len(target_items))</span>
</span><span id="__span-31-13"><a id="__codelineno-31-13" name="__codelineno-31-13" href="#__codelineno-31-13"></a><span class="n">scores</span> <span class="o">=</span> <span class="n">score_potential</span><span class="p">(</span>
</span><span id="__span-31-14"><a id="__codelineno-31-14" name="__codelineno-31-14" href="#__codelineno-31-14"></a>    <span class="n">user_purchase_history</span><span class="p">,</span> 
</span><span id="__span-31-15"><a id="__codelineno-31-15" name="__codelineno-31-15" href="#__codelineno-31-15"></a>    <span class="n">als_model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> 
</span><span id="__span-31-16"><a id="__codelineno-31-16" name="__codelineno-31-16" href="#__codelineno-31-16"></a>    <span class="n">target_categories</span><span class="o">=</span><span class="n">target_items</span>
</span><span id="__span-31-17"><a id="__codelineno-31-17" name="__codelineno-31-17" href="#__codelineno-31-17"></a><span class="p">)</span>
</span><span id="__span-31-18"><a id="__codelineno-31-18" name="__codelineno-31-18" href="#__codelineno-31-18"></a>
</span><span id="__span-31-19"><a id="__codelineno-31-19" name="__codelineno-31-19" href="#__codelineno-31-19"></a><span class="c1"># The highest scores correspond to the users most primed to buy those specific targets</span>
</span><span id="__span-31-20"><a id="__codelineno-31-20" name="__codelineno-31-20" href="#__codelineno-31-20"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cross-sell potential scores:&quot;</span><span class="p">)</span>
</span><span id="__span-31-21"><a id="__codelineno-31-21" name="__codelineno-31-21" href="#__codelineno-31-21"></a><span class="nb">print</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<h2 id="13-hybrid-recommender-als-association-rules">13. Hybrid Recommender (ALS + Association Rules)<a class="headerlink" href="#13-hybrid-recommender-als-association-rules" title="Permanent link">&para;</a></h2>
<p>The <code>Recommender</code> workflow class wraps both your collaborative filtering models (ALS) and Frequent Pattern Mining rules into a single API. This easily enables the two most common placement strategies in e-commerce: <strong>"For You"</strong> (ALS) and <strong>"Frequently Bought Together"</strong> (Association Rules).</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rusket</span><span class="w"> </span><span class="kn">import</span> <span class="n">Recommender</span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a><span class="c1"># Initialize with both your fitted ALS model and Rules DataFrame</span>
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a><span class="n">rec</span> <span class="o">=</span> <span class="n">Recommender</span><span class="p">(</span><span class="n">als_model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">rules_df</span><span class="o">=</span><span class="n">strong_rules</span><span class="p">)</span>
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a>
</span><span id="__span-32-6"><a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a><span class="c1"># 1. &quot;For You&quot; (Personalized cross-selling based on user history)</span>
</span><span id="__span-32-7"><a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a><span class="n">item_ids</span><span class="p">,</span> <span class="n">scores</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">recommend_for_user</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="mi">125</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span><span id="__span-32-8"><a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a>
</span><span id="__span-32-9"><a id="__codelineno-32-9" name="__codelineno-32-9" href="#__codelineno-32-9"></a><span class="c1"># 2. &quot;Frequently Bought Together&quot; (Cart-based additions)</span>
</span><span id="__span-32-10"><a id="__codelineno-32-10" name="__codelineno-32-10" href="#__codelineno-32-10"></a><span class="n">active_cart</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">]</span> <span class="c1"># User just added items 10 and 15</span>
</span><span id="__span-32-11"><a id="__codelineno-32-11" name="__codelineno-32-11" href="#__codelineno-32-11"></a><span class="n">suggested_additions</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">recommend_for_cart</span><span class="p">(</span><span class="n">active_cart</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<h2 id="14-genai-llm-stack-integration">14. GenAI / LLM Stack Integration<a class="headerlink" href="#14-genai-llm-stack-integration" title="Permanent link">&para;</a></h2>
<p><code>rusket</code> provides native utilities to export its learned representations and rules into the modern Generative AI and graph analytics stack.</p>
<h3 id="vector-export-vector-databases-lancedb">Vector Export &amp; Vector Databases (LanceDB)<a class="headerlink" href="#vector-export-vector-databases-lancedb" title="Permanent link">&para;</a></h3>
<p>You can easily export ALS latent user or item factors as vector embeddings to power RAG (Retrieval-Augmented Generation) or fast semantic similarity search in vector databases like LanceDB, FAISS, or Qdrant.</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">lancedb</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rusket</span><span class="w"> </span><span class="kn">import</span> <span class="n">export_item_factors</span>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a><span class="c1"># Export ALS item factors to a Pandas DataFrame</span>
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a><span class="c1"># Returns columns: [&#39;item_id&#39;, &#39;vector&#39;] (and &#39;item_label&#39; if available)</span>
</span><span id="__span-33-6"><a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a><span class="n">df_vectors</span> <span class="o">=</span> <span class="n">export_item_factors</span><span class="p">(</span><span class="n">als_model</span><span class="p">)</span>
</span><span id="__span-33-7"><a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a>
</span><span id="__span-33-8"><a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a><span class="c1"># Connect to a local LanceDB instance</span>
</span><span id="__span-33-9"><a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a><span class="n">db</span> <span class="o">=</span> <span class="n">lancedb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;./lancedb&quot;</span><span class="p">)</span>
</span><span id="__span-33-10"><a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a>
</span><span id="__span-33-11"><a id="__codelineno-33-11" name="__codelineno-33-11" href="#__codelineno-33-11"></a><span class="c1"># Ingest the embeddings into a table</span>
</span><span id="__span-33-12"><a id="__codelineno-33-12" name="__codelineno-33-12" href="#__codelineno-33-12"></a><span class="n">table</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="s2">&quot;item_embeddings&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df_vectors</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;overwrite&quot;</span><span class="p">)</span>
</span><span id="__span-33-13"><a id="__codelineno-33-13" name="__codelineno-33-13" href="#__codelineno-33-13"></a>
</span><span id="__span-33-14"><a id="__codelineno-33-14" name="__codelineno-33-14" href="#__codelineno-33-14"></a><span class="c1"># Perform a vector similarity search (e.g., finding items similar to a given query embedding)</span>
</span><span id="__span-33-15"><a id="__codelineno-33-15" name="__codelineno-33-15" href="#__codelineno-33-15"></a><span class="n">query_vector</span> <span class="o">=</span> <span class="n">df_vectors</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;vector&quot;</span><span class="p">]</span>
</span><span id="__span-33-16"><a id="__codelineno-33-16" name="__codelineno-33-16" href="#__codelineno-33-16"></a><span class="n">results</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">query_vector</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
</span><span id="__span-33-17"><a id="__codelineno-33-17" name="__codelineno-33-17" href="#__codelineno-33-17"></a><span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="fast-item-to-item-similarity">Fast Item-to-Item Similarity<a class="headerlink" href="#fast-item-to-item-similarity" title="Permanent link">&para;</a></h3>
<p>If you don't need a full vector database and just want fast, in-memory cosine similarity between items based on their ALS embeddings:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rusket</span><span class="w"> </span><span class="kn">import</span> <span class="n">similar_items</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a>
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a><span class="c1"># Find the top 5 most similar items to item_id=42 using Cosine Similarity</span>
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="n">similar_ids</span><span class="p">,</span> <span class="n">similarity_scores</span> <span class="o">=</span> <span class="n">similar_items</span><span class="p">(</span><span class="n">als_model</span><span class="p">,</span> <span class="n">item_id</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a>
</span><span id="__span-34-6"><a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Similar items: </span><span class="si">{</span><span class="n">similar_ids</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-34-7"><a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cosine similarities: </span><span class="si">{</span><span class="n">similarity_scores</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="graph-generation-for-community-detection">Graph Generation for Community Detection<a class="headerlink" href="#graph-generation-for-community-detection" title="Permanent link">&para;</a></h3>
<p>Frequent Pattern Mining rules can be naturally represented as a directed graph. You can automatically convert them into a <code>networkx</code> graph to run community detection (like Louvain) and discover "Product Clusters" or "Categories".</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rusket.viz</span><span class="w"> </span><span class="kn">import</span> <span class="n">to_networkx</span>
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a>
</span><span id="__span-35-4"><a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a><span class="c1"># rules is a Pandas DataFrame from rusket.association_rules()</span>
</span><span id="__span-35-5"><a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a><span class="c1"># We use &#39;lift&#39; as the edge weight connecting antecedents to consequents</span>
</span><span id="__span-35-6"><a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a><span class="n">G</span> <span class="o">=</span> <span class="n">to_networkx</span><span class="p">(</span><span class="n">rules_df</span><span class="p">,</span> <span class="n">source_col</span><span class="o">=</span><span class="s2">&quot;antecedents&quot;</span><span class="p">,</span> <span class="n">target_col</span><span class="o">=</span><span class="s2">&quot;consequents&quot;</span><span class="p">,</span> <span class="n">edge_attr</span><span class="o">=</span><span class="s2">&quot;lift&quot;</span><span class="p">)</span>
</span><span id="__span-35-7"><a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a>
</span><span id="__span-35-8"><a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a><span class="c1"># Run basic graph analytics</span>
</span><span id="__span-35-9"><a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Nodes: </span><span class="si">{</span><span class="n">G</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">()</span><span class="si">}</span><span class="s2">, Edges: </span><span class="si">{</span><span class="n">G</span><span class="o">.</span><span class="n">number_of_edges</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-35-10"><a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a>
</span><span id="__span-35-11"><a id="__codelineno-35-11" name="__codelineno-35-11" href="#__codelineno-35-11"></a><span class="c1"># E.g., calculate PageRank to find the most influential products</span>
</span><span id="__span-35-12"><a id="__codelineno-35-12" name="__codelineno-35-12" href="#__codelineno-35-12"></a><span class="n">centrality</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">pagerank</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;weight&#39;</span><span class="p">)</span>
</span><span id="__span-35-13"><a id="__codelineno-35-13" name="__codelineno-35-13" href="#__codelineno-35-13"></a><span class="n">top_items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">centrality</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span>
</span><span id="__span-35-14"><a id="__codelineno-35-14" name="__codelineno-35-14" href="#__codelineno-35-14"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Top central products:&quot;</span><span class="p">,</span> <span class="n">top_items</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<h2 id="15-visualizing-latent-spaces-pca">15. Visualizing Latent Spaces (PCA)<a class="headerlink" href="#15-visualizing-latent-spaces-pca" title="Permanent link">&para;</a></h2>
<p>When using <code>ALS</code>, raw embeddings capture both <strong>magnitude</strong> (how frequently an item is bought) and <strong>direction</strong> (the "taste" or behavioral profile of who buys it).</p>
<p>To map these multidimensional factors down to a 3D Plotly visualization for dashboarding, we apply <strong>L2 Normalization</strong> (to focus solely on Cosine Similarity / direction) followed by <strong>PCA</strong> (Principal Component Analysis).</p>
<p>Because <code>rusket</code> exposes ALS factors directly as NumPy arrays, you can do this <strong>without adding dependencies like <code>scikit-learn</code> or PySpark</strong>:</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">plotly.express</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">px</span>
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rusket</span><span class="w"> </span><span class="kn">import</span> <span class="n">ALS</span>
</span><span id="__span-36-5"><a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a>
</span><span id="__span-36-6"><a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a><span class="c1"># 1. Load the Online Retail dataset</span>
</span><span id="__span-36-7"><a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a><span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/databricks/Spark-The-Definitive-Guide/refs/heads/master/data/retail-data/all/online-retail-dataset.csv&quot;</span>
</span><span id="__span-36-8"><a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a><span class="n">df_purchases</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span id="__span-36-9"><a id="__codelineno-36-9" name="__codelineno-36-9" href="#__codelineno-36-9"></a><span class="n">df_purchases</span> <span class="o">=</span> <span class="n">df_purchases</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;CustomerID&quot;</span><span class="p">,</span> <span class="s2">&quot;Description&quot;</span><span class="p">])</span>
</span><span id="__span-36-10"><a id="__codelineno-36-10" name="__codelineno-36-10" href="#__codelineno-36-10"></a>
</span><span id="__span-36-11"><a id="__codelineno-36-11" name="__codelineno-36-11" href="#__codelineno-36-11"></a><span class="c1"># 2. Fit an ALS model</span>
</span><span id="__span-36-12"><a id="__codelineno-36-12" name="__codelineno-36-12" href="#__codelineno-36-12"></a><span class="n">model</span> <span class="o">=</span> <span class="n">ALS</span><span class="o">.</span><span class="n">from_transactions</span><span class="p">(</span><span class="n">df_purchases</span><span class="p">,</span> <span class="n">transaction_col</span><span class="o">=</span><span class="s2">&quot;CustomerID&quot;</span><span class="p">,</span> <span class="n">item_col</span><span class="o">=</span><span class="s2">&quot;StockCode&quot;</span><span class="p">,</span> <span class="n">factors</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">40.0</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
</span><span id="__span-36-13"><a id="__codelineno-36-13" name="__codelineno-36-13" href="#__codelineno-36-13"></a>
</span><span id="__span-36-14"><a id="__codelineno-36-14" name="__codelineno-36-14" href="#__codelineno-36-14"></a><span class="c1"># 3. L2 Normalization (Unit Sphere Projection) using pure NumPy</span>
</span><span id="__span-36-15"><a id="__codelineno-36-15" name="__codelineno-36-15" href="#__codelineno-36-15"></a><span class="c1"># Divide each latent factor row by its L2 norm (magnitude)</span>
</span><span id="__span-36-16"><a id="__codelineno-36-16" name="__codelineno-36-16" href="#__codelineno-36-16"></a><span class="n">item_factors</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">item_factors</span>
</span><span id="__span-36-17"><a id="__codelineno-36-17" name="__codelineno-36-17" href="#__codelineno-36-17"></a><span class="n">item_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">item_factors</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-36-18"><a id="__codelineno-36-18" name="__codelineno-36-18" href="#__codelineno-36-18"></a><span class="n">item_factors_norm</span> <span class="o">=</span> <span class="n">item_factors</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">item_norms</span><span class="p">,</span> <span class="n">a_min</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span> <span class="n">a_max</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="__span-36-19"><a id="__codelineno-36-19" name="__codelineno-36-19" href="#__codelineno-36-19"></a>
</span><span id="__span-36-20"><a id="__codelineno-36-20" name="__codelineno-36-20" href="#__codelineno-36-20"></a><span class="c1"># 4. PCA Reduction (e.g. 64D -&gt; 3D) using Singular Value Decomposition</span>
</span><span id="__span-36-21"><a id="__codelineno-36-21" name="__codelineno-36-21" href="#__codelineno-36-21"></a><span class="k">def</span><span class="w"> </span><span class="nf">compute_pca_3d</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span><span id="__span-36-22"><a id="__codelineno-36-22" name="__codelineno-36-22" href="#__codelineno-36-22"></a>    <span class="c1"># Mean centering</span>
</span><span id="__span-36-23"><a id="__codelineno-36-23" name="__codelineno-36-23" href="#__codelineno-36-23"></a>    <span class="n">data_centered</span> <span class="o">=</span> <span class="n">data</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-36-24"><a id="__codelineno-36-24" name="__codelineno-36-24" href="#__codelineno-36-24"></a>
</span><span id="__span-36-25"><a id="__codelineno-36-25" name="__codelineno-36-25" href="#__codelineno-36-25"></a>    <span class="c1"># SVD</span>
</span><span id="__span-36-26"><a id="__codelineno-36-26" name="__codelineno-36-26" href="#__codelineno-36-26"></a>    <span class="n">U</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">Vt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">data_centered</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="__span-36-27"><a id="__codelineno-36-27" name="__codelineno-36-27" href="#__codelineno-36-27"></a>
</span><span id="__span-36-28"><a id="__codelineno-36-28" name="__codelineno-36-28" href="#__codelineno-36-28"></a>    <span class="c1"># Extract the top 3 principal components map</span>
</span><span id="__span-36-29"><a id="__codelineno-36-29" name="__codelineno-36-29" href="#__codelineno-36-29"></a>    <span class="n">components</span> <span class="o">=</span> <span class="n">Vt</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
</span><span id="__span-36-30"><a id="__codelineno-36-30" name="__codelineno-36-30" href="#__codelineno-36-30"></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">data_centered</span><span class="p">,</span> <span class="n">components</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span id="__span-36-31"><a id="__codelineno-36-31" name="__codelineno-36-31" href="#__codelineno-36-31"></a>
</span><span id="__span-36-32"><a id="__codelineno-36-32" name="__codelineno-36-32" href="#__codelineno-36-32"></a><span class="n">item_pca</span> <span class="o">=</span> <span class="n">compute_pca_3d</span><span class="p">(</span><span class="n">item_factors_norm</span><span class="p">)</span>
</span><span id="__span-36-33"><a id="__codelineno-36-33" name="__codelineno-36-33" href="#__codelineno-36-33"></a>
</span><span id="__span-36-34"><a id="__codelineno-36-34" name="__codelineno-36-34" href="#__codelineno-36-34"></a><span class="c1"># 5. Bind arrays back to a Pandas DataFrame for Plotly</span>
</span><span id="__span-36-35"><a id="__codelineno-36-35" name="__codelineno-36-35" href="#__codelineno-36-35"></a><span class="n">df_viz</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
</span><span id="__span-36-36"><a id="__codelineno-36-36" name="__codelineno-36-36" href="#__codelineno-36-36"></a>    <span class="s2">&quot;StockCode&quot;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">_item_labels</span><span class="p">,</span> <span class="c1"># The original dataset IDs mapped back</span>
</span><span id="__span-36-37"><a id="__codelineno-36-37" name="__codelineno-36-37" href="#__codelineno-36-37"></a>    <span class="s2">&quot;pca_1&quot;</span><span class="p">:</span> <span class="n">item_pca</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="__span-36-38"><a id="__codelineno-36-38" name="__codelineno-36-38" href="#__codelineno-36-38"></a>    <span class="s2">&quot;pca_2&quot;</span><span class="p">:</span> <span class="n">item_pca</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="__span-36-39"><a id="__codelineno-36-39" name="__codelineno-36-39" href="#__codelineno-36-39"></a>    <span class="s2">&quot;pca_3&quot;</span><span class="p">:</span> <span class="n">item_pca</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="__span-36-40"><a id="__codelineno-36-40" name="__codelineno-36-40" href="#__codelineno-36-40"></a><span class="p">})</span>
</span><span id="__span-36-41"><a id="__codelineno-36-41" name="__codelineno-36-41" href="#__codelineno-36-41"></a>
</span><span id="__span-36-42"><a id="__codelineno-36-42" name="__codelineno-36-42" href="#__codelineno-36-42"></a><span class="c1"># Merge descriptions back in for hover labels</span>
</span><span id="__span-36-43"><a id="__codelineno-36-43" name="__codelineno-36-43" href="#__codelineno-36-43"></a><span class="n">df_items</span> <span class="o">=</span> <span class="n">df_purchases</span><span class="p">[[</span><span class="s2">&quot;StockCode&quot;</span><span class="p">,</span> <span class="s2">&quot;Description&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="s2">&quot;StockCode&quot;</span><span class="p">)</span>
</span><span id="__span-36-44"><a id="__codelineno-36-44" name="__codelineno-36-44" href="#__codelineno-36-44"></a><span class="n">df_viz</span> <span class="o">=</span> <span class="n">df_viz</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_items</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;StockCode&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">)</span>
</span><span id="__span-36-45"><a id="__codelineno-36-45" name="__codelineno-36-45" href="#__codelineno-36-45"></a>
</span><span id="__span-36-46"><a id="__codelineno-36-46" name="__codelineno-36-46" href="#__codelineno-36-46"></a><span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">scatter_3d</span><span class="p">(</span>
</span><span id="__span-36-47"><a id="__codelineno-36-47" name="__codelineno-36-47" href="#__codelineno-36-47"></a>    <span class="n">df_viz</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;pca_1&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;pca_2&quot;</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="s2">&quot;pca_3&quot;</span><span class="p">,</span>
</span><span id="__span-36-48"><a id="__codelineno-36-48" name="__codelineno-36-48" href="#__codelineno-36-48"></a>    <span class="n">hover_name</span><span class="o">=</span><span class="s2">&quot;Description&quot;</span><span class="p">,</span>
</span><span id="__span-36-49"><a id="__codelineno-36-49" name="__codelineno-36-49" href="#__codelineno-36-49"></a>    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;ALS Latent Space (3D PCA Mapping)&quot;</span>
</span><span id="__span-36-50"><a id="__codelineno-36-50" name="__codelineno-36-50" href="#__codelineno-36-50"></a><span class="p">)</span>
</span><span id="__span-36-51"><a id="__codelineno-36-51" name="__codelineno-36-51" href="#__codelineno-36-51"></a><span class="n">fig</span><span class="o">.</span><span class="n">update_traces</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.7</span><span class="p">))</span>
</span><span id="__span-36-52"><a id="__codelineno-36-52" name="__codelineno-36-52" href="#__codelineno-36-52"></a><span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></code></pre></div>
<p>This workflow matches Spark MLlib's dimensionality reduction pipelines seamlessly while executing locally in microseconds.</p>
<hr />
<h2 id="16-translating-spark-mllib-to-rusket">16. Translating Spark MLlib to <code>rusket</code><a class="headerlink" href="#16-translating-spark-mllib-to-rusket" title="Permanent link">&para;</a></h2>
<p>For users migrating from Databricks or PySpark, <code>rusket</code> offers a highly similar API without the distributed computing overhead. </p>
<p>This example translates the famous Recommendation example from Chapter 28 of <strong>Spark: The Definitive Guide</strong> directly into <code>rusket</code> using pure Python and Pandas.</p>
<h3 id="spark-version-original">Spark Version (Original)<a class="headerlink" href="#spark-version-original" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pyspark.ml.recommendation</span><span class="w"> </span><span class="kn">import</span> <span class="n">ALS</span>
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pyspark.ml.evaluation</span><span class="w"> </span><span class="kn">import</span> <span class="n">RegressionEvaluator</span>
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a>
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a><span class="n">ratings</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;/data/sample_movielens_ratings.txt&quot;</span><span class="p">)</span> \
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a>  <span class="o">.</span><span class="n">selectExpr</span><span class="p">(</span><span class="s2">&quot;split(value, &#39;::&#39;) as col&quot;</span><span class="p">)</span> \
</span><span id="__span-37-6"><a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a>  <span class="o">.</span><span class="n">selectExpr</span><span class="p">(</span>
</span><span id="__span-37-7"><a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a>      <span class="s2">&quot;cast(col[0] as int) as userId&quot;</span><span class="p">,</span>
</span><span id="__span-37-8"><a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a>      <span class="s2">&quot;cast(col[1] as int) as movieId&quot;</span><span class="p">,</span>
</span><span id="__span-37-9"><a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a>      <span class="s2">&quot;cast(col[2] as float) as rating&quot;</span>
</span><span id="__span-37-10"><a id="__codelineno-37-10" name="__codelineno-37-10" href="#__codelineno-37-10"></a>  <span class="p">)</span>
</span><span id="__span-37-11"><a id="__codelineno-37-11" name="__codelineno-37-11" href="#__codelineno-37-11"></a>
</span><span id="__span-37-12"><a id="__codelineno-37-12" name="__codelineno-37-12" href="#__codelineno-37-12"></a><span class="n">training</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">ratings</span><span class="o">.</span><span class="n">randomSplit</span><span class="p">([</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>
</span><span id="__span-37-13"><a id="__codelineno-37-13" name="__codelineno-37-13" href="#__codelineno-37-13"></a>
</span><span id="__span-37-14"><a id="__codelineno-37-14" name="__codelineno-37-14" href="#__codelineno-37-14"></a><span class="n">als</span> <span class="o">=</span> <span class="n">ALS</span><span class="p">()</span><span class="o">.</span><span class="n">setMaxIter</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">setRegParam</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span> \
</span><span id="__span-37-15"><a id="__codelineno-37-15" name="__codelineno-37-15" href="#__codelineno-37-15"></a>  <span class="o">.</span><span class="n">setUserCol</span><span class="p">(</span><span class="s2">&quot;userId&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setItemCol</span><span class="p">(</span><span class="s2">&quot;movieId&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setRatingCol</span><span class="p">(</span><span class="s2">&quot;rating&quot;</span><span class="p">)</span>
</span><span id="__span-37-16"><a id="__codelineno-37-16" name="__codelineno-37-16" href="#__codelineno-37-16"></a>
</span><span id="__span-37-17"><a id="__codelineno-37-17" name="__codelineno-37-17" href="#__codelineno-37-17"></a><span class="n">alsModel</span> <span class="o">=</span> <span class="n">als</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">training</span><span class="p">)</span>
</span><span id="__span-37-18"><a id="__codelineno-37-18" name="__codelineno-37-18" href="#__codelineno-37-18"></a><span class="n">predictions</span> <span class="o">=</span> <span class="n">alsModel</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
</span><span id="__span-37-19"><a id="__codelineno-37-19" name="__codelineno-37-19" href="#__codelineno-37-19"></a>
</span><span id="__span-37-20"><a id="__codelineno-37-20" name="__codelineno-37-20" href="#__codelineno-37-20"></a><span class="n">evaluator</span> <span class="o">=</span> <span class="n">RegressionEvaluator</span><span class="p">()</span><span class="o">.</span><span class="n">setMetricName</span><span class="p">(</span><span class="s2">&quot;rmse&quot;</span><span class="p">)</span> \
</span><span id="__span-37-21"><a id="__codelineno-37-21" name="__codelineno-37-21" href="#__codelineno-37-21"></a>  <span class="o">.</span><span class="n">setLabelCol</span><span class="p">(</span><span class="s2">&quot;rating&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setPredictionCol</span><span class="p">(</span><span class="s2">&quot;prediction&quot;</span><span class="p">)</span>
</span><span id="__span-37-22"><a id="__codelineno-37-22" name="__codelineno-37-22" href="#__codelineno-37-22"></a>
</span><span id="__span-37-23"><a id="__codelineno-37-23" name="__codelineno-37-23" href="#__codelineno-37-23"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RMSE =&quot;</span><span class="p">,</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">predictions</span><span class="p">))</span>
</span></code></pre></div>
<h3 id="rusket-version-equivalent"><code>rusket</code> Version (Equivalent)<a class="headerlink" href="#rusket-version-equivalent" title="Permanent link">&para;</a></h3>
<div class="language-python highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rusket</span><span class="w"> </span><span class="kn">import</span> <span class="n">ALS</span>
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a>
</span><span id="__span-38-5"><a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a><span class="c1"># 1. Load the data using Pandas</span>
</span><span id="__span-38-6"><a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a><span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/apache/spark/master/data/mllib/als/sample_movielens_ratings.txt&quot;</span>
</span><span id="__span-38-7"><a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a><span class="n">ratings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;::&quot;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">,</span> 
</span><span id="__span-38-8"><a id="__codelineno-38-8" name="__codelineno-38-8" href="#__codelineno-38-8"></a>                      <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;userId&quot;</span><span class="p">,</span> <span class="s2">&quot;movieId&quot;</span><span class="p">,</span> <span class="s2">&quot;rating&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">])</span>
</span><span id="__span-38-9"><a id="__codelineno-38-9" name="__codelineno-38-9" href="#__codelineno-38-9"></a>
</span><span id="__span-38-10"><a id="__codelineno-38-10" name="__codelineno-38-10" href="#__codelineno-38-10"></a><span class="c1"># 2. Random Split (80/20)</span>
</span><span id="__span-38-11"><a id="__codelineno-38-11" name="__codelineno-38-11" href="#__codelineno-38-11"></a><span class="n">shuffled</span> <span class="o">=</span> <span class="n">ratings</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
</span><span id="__span-38-12"><a id="__codelineno-38-12" name="__codelineno-38-12" href="#__codelineno-38-12"></a><span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shuffled</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)</span>
</span><span id="__span-38-13"><a id="__codelineno-38-13" name="__codelineno-38-13" href="#__codelineno-38-13"></a><span class="n">training</span> <span class="o">=</span> <span class="n">shuffled</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">]</span>
</span><span id="__span-38-14"><a id="__codelineno-38-14" name="__codelineno-38-14" href="#__codelineno-38-14"></a><span class="n">test</span> <span class="o">=</span> <span class="n">shuffled</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
</span><span id="__span-38-15"><a id="__codelineno-38-15" name="__codelineno-38-15" href="#__codelineno-38-15"></a>
</span><span id="__span-38-16"><a id="__codelineno-38-16" name="__codelineno-38-16" href="#__codelineno-38-16"></a><span class="c1"># 3. Initialize and Fit the ALS Model</span>
</span><span id="__span-38-17"><a id="__codelineno-38-17" name="__codelineno-38-17" href="#__codelineno-38-17"></a><span class="c1"># Note: rusket uses `factors` instead of `rank`, and `iterations` instead of `maxIter`.</span>
</span><span id="__span-38-18"><a id="__codelineno-38-18" name="__codelineno-38-18" href="#__codelineno-38-18"></a><span class="n">model</span> <span class="o">=</span> <span class="n">ALS</span><span class="o">.</span><span class="n">from_transactions</span><span class="p">(</span><span class="n">training</span><span class="p">,</span> <span class="n">transaction_col</span><span class="o">=</span><span class="s2">&quot;userId&quot;</span><span class="p">,</span> <span class="n">item_col</span><span class="o">=</span><span class="s2">&quot;movieId&quot;</span><span class="p">,</span> <span class="n">rating_col</span><span class="o">=</span><span class="s2">&quot;rating&quot;</span><span class="p">,</span> <span class="n">factors</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">regularization</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
</span><span id="__span-38-19"><a id="__codelineno-38-19" name="__codelineno-38-19" href="#__codelineno-38-19"></a>
</span><span id="__span-38-20"><a id="__codelineno-38-20" name="__codelineno-38-20" href="#__codelineno-38-20"></a><span class="c1"># 4. Generate Predictions for the test set</span>
</span><span id="__span-38-21"><a id="__codelineno-38-21" name="__codelineno-38-21" href="#__codelineno-38-21"></a><span class="c1"># rusket has a built-in vectorized score_potential helper for evaluating target vectors</span>
</span><span id="__span-38-22"><a id="__codelineno-38-22" name="__codelineno-38-22" href="#__codelineno-38-22"></a><span class="kn">from</span><span class="w"> </span><span class="nn">rusket.recommend</span><span class="w"> </span><span class="kn">import</span> <span class="n">score_potential</span>
</span><span id="__span-38-23"><a id="__codelineno-38-23" name="__codelineno-38-23" href="#__codelineno-38-23"></a>
</span><span id="__span-38-24"><a id="__codelineno-38-24" name="__codelineno-38-24" href="#__codelineno-38-24"></a><span class="c1"># We reconstruct the user&#39;s history from the training set to mask known interactions</span>
</span><span id="__span-38-25"><a id="__codelineno-38-25" name="__codelineno-38-25" href="#__codelineno-38-25"></a><span class="n">user_histories</span> <span class="o">=</span> <span class="n">training</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;userId&quot;</span><span class="p">)[</span><span class="s2">&quot;movieId&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
</span><span id="__span-38-26"><a id="__codelineno-38-26" name="__codelineno-38-26" href="#__codelineno-38-26"></a><span class="c1"># Ensure all users in the test set exist in our history mapping, even if empty</span>
</span><span id="__span-38-27"><a id="__codelineno-38-27" name="__codelineno-38-27" href="#__codelineno-38-27"></a><span class="n">history_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">user_histories</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">uid</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_n_users</span><span class="p">)]</span>
</span><span id="__span-38-28"><a id="__codelineno-38-28" name="__codelineno-38-28" href="#__codelineno-38-28"></a>
</span><span id="__span-38-29"><a id="__codelineno-38-29" name="__codelineno-38-29" href="#__codelineno-38-29"></a><span class="c1"># Calculate raw prediction scores across all users and all items</span>
</span><span id="__span-38-30"><a id="__codelineno-38-30" name="__codelineno-38-30" href="#__codelineno-38-30"></a><span class="n">all_predictions</span> <span class="o">=</span> <span class="n">score_potential</span><span class="p">(</span><span class="n">history_list</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
</span><span id="__span-38-31"><a id="__codelineno-38-31" name="__codelineno-38-31" href="#__codelineno-38-31"></a>
</span><span id="__span-38-32"><a id="__codelineno-38-32" name="__codelineno-38-32" href="#__codelineno-38-32"></a><span class="c1"># 5. Evaluate RMSE</span>
</span><span id="__span-38-33"><a id="__codelineno-38-33" name="__codelineno-38-33" href="#__codelineno-38-33"></a><span class="c1"># Extract only the actual ratings we care about from the test set</span>
</span><span id="__span-38-34"><a id="__codelineno-38-34" name="__codelineno-38-34" href="#__codelineno-38-34"></a><span class="n">test_users</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="s2">&quot;userId&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="__span-38-35"><a id="__codelineno-38-35" name="__codelineno-38-35" href="#__codelineno-38-35"></a><span class="n">test_movies</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="s2">&quot;movieId&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="__span-38-36"><a id="__codelineno-38-36" name="__codelineno-38-36" href="#__codelineno-38-36"></a><span class="n">actual_ratings</span> <span class="o">=</span> <span class="n">test</span><span class="p">[</span><span class="s2">&quot;rating&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="__span-38-37"><a id="__codelineno-38-37" name="__codelineno-38-37" href="#__codelineno-38-37"></a>
</span><span id="__span-38-38"><a id="__codelineno-38-38" name="__codelineno-38-38" href="#__codelineno-38-38"></a><span class="c1"># Map the raw pandas IDs to rusket&#39;s internal 0-indexed matrix IDs</span>
</span><span id="__span-38-39"><a id="__codelineno-38-39" name="__codelineno-38-39" href="#__codelineno-38-39"></a><span class="k">try</span><span class="p">:</span>
</span><span id="__span-38-40"><a id="__codelineno-38-40" name="__codelineno-38-40" href="#__codelineno-38-40"></a>    <span class="n">internal_user_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">model</span><span class="o">.</span><span class="n">_user_labels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">test_users</span><span class="p">])</span>
</span><span id="__span-38-41"><a id="__codelineno-38-41" name="__codelineno-38-41" href="#__codelineno-38-41"></a>    <span class="n">internal_movie_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">model</span><span class="o">.</span><span class="n">_item_labels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">test_movies</span><span class="p">])</span>
</span><span id="__span-38-42"><a id="__codelineno-38-42" name="__codelineno-38-42" href="#__codelineno-38-42"></a>
</span><span id="__span-38-43"><a id="__codelineno-38-43" name="__codelineno-38-43" href="#__codelineno-38-43"></a>    <span class="c1"># Extract predicted ratings</span>
</span><span id="__span-38-44"><a id="__codelineno-38-44" name="__codelineno-38-44" href="#__codelineno-38-44"></a>    <span class="n">predicted_ratings</span> <span class="o">=</span> <span class="n">all_predictions</span><span class="p">[</span><span class="n">internal_user_ids</span><span class="p">,</span> <span class="n">internal_movie_ids</span><span class="p">]</span>
</span><span id="__span-38-45"><a id="__codelineno-38-45" name="__codelineno-38-45" href="#__codelineno-38-45"></a>
</span><span id="__span-38-46"><a id="__codelineno-38-46" name="__codelineno-38-46" href="#__codelineno-38-46"></a>    <span class="c1"># Calculate RMSE</span>
</span><span id="__span-38-47"><a id="__codelineno-38-47" name="__codelineno-38-47" href="#__codelineno-38-47"></a>    <span class="n">valid_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">predicted_ratings</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">predicted_ratings</span><span class="p">)</span>
</span><span id="__span-38-48"><a id="__codelineno-38-48" name="__codelineno-38-48" href="#__codelineno-38-48"></a>    <span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">predicted_ratings</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">actual_ratings</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
</span><span id="__span-38-49"><a id="__codelineno-38-49" name="__codelineno-38-49" href="#__codelineno-38-49"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Root-mean-square error = </span><span class="si">{</span><span class="n">rmse</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-38-50"><a id="__codelineno-38-50" name="__codelineno-38-50" href="#__codelineno-38-50"></a>
</span><span id="__span-38-51"><a id="__codelineno-38-51" name="__codelineno-38-51" href="#__codelineno-38-51"></a><span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-38-52"><a id="__codelineno-38-52" name="__codelineno-38-52" href="#__codelineno-38-52"></a>    <span class="c1"># Handle cold-start users/items in the test set not seen in training</span>
</span><span id="__span-38-53"><a id="__codelineno-38-53" name="__codelineno-38-53" href="#__codelineno-38-53"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cold start warning: Some users/items in test set were not in training.&quot;</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="explanation-of-key-differences">Explanation of Key Differences<a class="headerlink" href="#explanation-of-key-differences" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>No Distributed Execution:</strong> PySpark builds physical query plans (<code>.transform()</code>, <code>.show()</code>). <code>rusket</code> executes completely eagerly in memory, heavily relying on Rust arrays and <code>numpy</code> for C-level vector operations.</li>
<li><strong>Cold Starts:</strong> <code>rusket</code> is designed for implicit feedback recommendations, and its <code>transform</code>/prediction step expects <code>user_id</code> and <code>item_id</code> values to have been seen during <code>.fit()</code>. Proper production code should handle cold starts with popularity backups instead of omitting them.</li>
<li><strong>Implicit vs Explicit Feedback:</strong> The Databricks exact example uses ALS for <em>explicit</em> ratings out of 5 stars to calculate Regression Error (RMSE). <code>rusket</code> focuses entirely on <em>implicit</em> feedback (clicks, purchases), so it's optimized for calculating Ranking Metrics (like Precision@K) rather than Regression Error. The math works identically, but it scales differently.</li>
</ol>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../api-reference/" class="md-footer__link md-footer__link--prev" aria-label="Previous: API Reference">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                API Reference
              </div>
            </div>
          </a>
        
        
          
          <a href="../notebooks/1_online_retail_basket_analysis/" class="md-footer__link md-footer__link--next" aria-label="Next: üõí Retail Assortment Optimization">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                üõí Retail Assortment Optimization
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/bmsuisse/rusket" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://pypi.org/project/rusket/" target="_blank" rel="noopener" title="pypi.org" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.8 200.5c-7.7-30.9-22.3-54.2-53.4-54.2h-40.1v47.4c0 36.8-31.2 67.8-66.8 67.8H172.7c-29.2 0-53.4 25-53.4 54.3v101.8c0 29 25.2 46 53.4 54.3 33.8 9.9 66.3 11.7 106.8 0 26.9-7.8 53.4-23.5 53.4-54.3v-40.7H226.2v-13.6h160.2c31.1 0 42.6-21.7 53.4-54.2 11.2-33.5 10.7-65.7 0-108.6M286.2 444.7a20.4 20.4 0 1 1 0-40.7 20.4 20.4 0 1 1 0 40.7M167.8 248.1h106.8c29.7 0 53.4-24.5 53.4-54.3V91.9c0-29-24.4-50.7-53.4-55.6-35.8-5.9-74.7-5.6-106.8.1-45.2 8-53.4 24.7-53.4 55.6v40.7h106.9v13.6h-147c-31.1 0-58.3 18.7-66.8 54.2-9.8 40.7-10.2 66.1 0 108.6 7.6 31.6 25.7 54.2 56.8 54.2H101v-48.8c0-35.3 30.5-66.4 66.8-66.4m-6.6-183.4a20.4 20.4 0 1 1 0 40.8 20.4 20.4 0 1 1 0-40.8"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": ["navigation.instant", "navigation.instant.prefetch", "navigation.tracking", "navigation.tabs", "navigation.sections", "navigation.expand", "navigation.top", "navigation.footer", "toc.follow", "search.suggest", "search.highlight", "content.code.copy", "content.code.annotate", "content.tabs.link"], "search": "../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>