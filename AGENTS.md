# rusket Agent Guidelines

## Project Overview
rusket is a blazing fast library and a drop-in replacement for `mlxtend`'s FP-Growth and Association Rules. It uses:
- **Rust** (via PyO3 + maturin) for the core high-performance mining algorithms.
- **Python** (3.10+) for the public API surface and data validation.
- **uv** for Python package management and virtual environment execution.
- **Rayon** for parallel processing in Rust.
- **zero-copy buffers** from Pandas (dense/sparse) and Polars via NumPy arrays.

## Critical Rules

### Always Use `uv`
- **All Python commands MUST use `uv run`** ‚Äî never use `.venv/bin/python` or bare `python`.
- Tests: `uv run pytest tests/ -x -q`
- Benchmarks: `uv run pytest tests/test_benchmark.py -v -s`
- Type checking: `uv run pyright`
- Smoke test: `uv run python -c "import rusket; print('rusket imported successfully')"`

### Build Workflow
1. `cargo check` ‚Äî fast compilation check for the Rust codebase.
2. `uv run maturin develop --release` ‚Äî build optimized extension and inject it into the `.venv`.

### Pre-Commit Checklist
1. `cargo check` ‚Äî no Rust errors.
2. `uv run maturin develop --release` ‚Äî build extension.
3. `uv run pytest tests/ -x -q` ‚Äî all tests pass (always run tests before commit).
4. `uv run pyright` ‚Äî type checking passes.
*(Run e2e tests/benchmarks after implementing new features)*

### General Development Guidelines
- **File Size Limit**: No file should exceed 1000 lines of code.
- **Branching**: Create a branch for each feature.
- **Temporary / scratch files**: Never drop throwaway files (e.g. `test_*.rs`, `scratch_*.py`) in the repo root or anywhere tracked by git. If you need a sandbox file while investigating something, put it inside `.temp/` ‚Äî that directory is in `.gitignore` and will never be committed.

## YOLO

**YOLO** means: `git add -A && git commit && git push origin main` **and** release a new version ‚Äî all on the `main` branch in one go.

Steps:
1. `git add -A`
2. `git commit -m "<message>"`
3. Bump version in `Cargo.toml` and `pyproject.toml`, then `git commit -am "release: vX.Y.Z"`
4. `git tag vX.Y.Z`
5. `git push origin main && git push origin vX.Y.Z`

CI takes it from there. üöÄ

## Releasing a New Version

The CI automatically builds wheels for all platforms, generates a changelog, and publishes to PyPI when a **git tag** is pushed.

### Steps
1. **Bump version** in both `Cargo.toml` (under `[package]`) and `pyproject.toml` (under `[project]`).
2. **Commit** the version bump: `git commit -am "release: v0.X.Y"`
3. **Tag** the commit: `git tag v0.X.Y`
4. **Push** the tag: `git push origin main && git push origin v0.X.Y`
5. CI will:
   - Run tests on all defined Python versions.
   - Build wheels for all specified platforms.
   - Generate changelog from conventional commits (via `git-cliff`).
   - Publish to PyPI.
   - Create a GitHub Release with the changelog and wheel assets.

### Commit Convention
Use [Conventional Commits](https://www.conventionalcommits.org/) for automatic changelog categorization:

| Prefix | Category | Example |
|--------|----------|---------|
| `feat:` | üöÄ Features | `feat: support null values in sparse matrices` |
| `fix:` | üêõ Bug Fixes | `fix: handle edge cases in confidence calculation` |
| `perf:` | ‚ö° Performance | `perf: zero-copy conversion for PyArrow arrays` |
| `refactor:` | üîß Refactoring | `refactor: split association rules module` |
| `docs:` | üìñ Documentation | `docs: add polars usage to README` |
| `ci:` | üîÑ CI/CD | `ci: add python 3.12 target` |
| `chore:` | üì¶ Miscellaneous | `chore: update dependencies` |
| `release:` | _(skipped)_ | `release: v0.1.1` |

The changelog is generated by `git-cliff` using `cliff.toml` config and appears as the GitHub Release body.

### Generate Changelog Locally
```bash
# Install git-cliff
cargo install git-cliff

# Preview changelog for unreleased changes
git cliff --unreleased

# Full changelog
git cliff
```

### Verify before releasing
```bash
cargo check
uv run maturin develop --release
uv run pytest tests/ -x -q
uv run pyright
```

## Architecture Notes
- **Rust Library Root**: `src/lib.rs`
- **Core FP-Growth mining**: `src/fpgrowth.rs` (builds the FP-Tree and mines itemsets)
- **Core Association Rules**: `src/association_rules.rs` (Rayon-parallelized metrics generation)
- **Python Thin Wrappers**: `rusket/fpgrowth.py`, `rusket/association_rules.py`
- **Type Stubs**: `rusket/_rusket.pyi`
- **Data Flow**: Python inputs (Pandas/Polars) are validated and converted into raw NumPy/CSR arrays (`fpgrowth_from_dense` or `fpgrowth_from_csr`) allowing Rust to process them without round-trips or Python loops.

## CI/CD Workflows (`.github/workflows/`)

### `ci.yml` ‚Äî Tests, Builds & PyPI Release
- **Triggers**: push to `main`, tags (`v*`), PRs, manual dispatch.
- **Test matrix**: Python 3.10‚Äì3.14 (including free-threaded `3.13t`/`3.14t`).
- **Wheel builds** (linux, musllinux, windows, macos) only run on **tag pushes** or **workflow_dispatch**.
- **PyPI publish** uses `PYPI_TOKEN` secret (already configured in repo settings).
- **GitHub Release** is auto-created with a `git-cliff` changelog.

### `docs.yml` ‚Äî MkDocs ‚Üí GitHub Pages
- **Triggers**: push to `main` (only `docs/**` or `mkdocs.yml` changes), manual dispatch.
- **Key**: uses `uv run --extra docs` to install mkdocs deps from `[project.optional-dependencies] docs` group, then `mkdocs gh-deploy --force`.
- **Published at**: `https://bmsuisse.github.io/rusket`

### Important CI/CD Rules
- **Never commit `site/`** ‚Äî it's the MkDocs build output and is in `.gitignore`. The `gh-deploy` command pushes it to the `gh-pages` branch automatically.
- **GitHub Pages must be explicitly enabled** ‚Äî `gh-deploy` creates the `gh-pages` branch but does NOT enable GitHub Pages serving. If the site is 404, run: `gh api repos/bmsuisse/rusket/pages --method POST -f 'source[branch]=gh-pages' -f 'source[path]=/'`
- **All repo references must use `bmsuisse/rusket`** ‚Äî the old name was `fpgrowth-pyo3`. Check `mkdocs.yml`, docs, and README if renaming.
- **Action versions**: keep `actions/checkout`, `actions/setup-python`, `astral-sh/setup-uv` in sync across both workflows.
- **uv consistency**: always use `uv run` ‚Äî never `uv pip install --system` (deps won't be visible to `uv run`).
